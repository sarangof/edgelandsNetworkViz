<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>People Network (draft)</title>
  <style>
    html, body { margin:0; height:100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { display:grid; grid-template-columns: 320px 1fr; height:100%; }
    #left { padding:12px; border-right:1px solid #eee; overflow:auto; background: var(--panel-background, #ffffff); }
    #sigma.vis2d { position:relative; background: var(--graph-background, #ffffff); }
    #stage { position:absolute; inset:0; }
    h2.h2 { margin:0 0 10px; font-size:16px; font-weight:600; }
    label { display:block; font-weight:600; margin-top:10px; }
    select, input[type="text"] { width:100%; padding:6px; border:1px solid #ddd; border-radius:6px; }
    button { padding:6px 10px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer; }
    .row { display:flex; gap:8px; margin-top:10px; }
    .stat { color:#666; font-size:12px; margin-top:8px; }
    table.table { width:100%; border-collapse:collapse; font-size:12px; margin-top:10px; }
    table.table th, table.table td { border:1px solid #eee; padding:6px 8px; text-align:left; }
    table.table th { background:#fafafa; position:sticky; top:0; }
    .pill { display:inline-block; font-size:11px; border:1px solid #ddd; border-radius:999px; padding:2px 6px; margin-left:6px; }
  </style>

  <!-- Fonts + brand stylesheet -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="brand.css">
</head>
<body class="theme--formal">
<div id="app">
  <div id="left">
    <h2 class="h2">People Network (mock)</h2>
    <div class="stat" id="counts"></div>

    <label for="edgeRule">Edges</label>
    <select id="edgeRule">
      <option value="random">Random (demo)</option>
      <option value="city">Same City</option>
      <option value="org">Same Organization</option>
      <option value="event">Same Event/Connection</option>
    </select>

    <div class="row">
      <div style="flex:1;">
        <label for="cityFilter">Filter: City</label>
        <select id="cityFilter"><option value="">(all)</option></select>
      </div>
      <div style="flex:1;">
        <label for="orgSearch">Search: Organization</label>
        <input id="orgSearch" type="text" placeholder="type to filter…" />
      </div>
    </div>

    <div class="row">
      <button id="reset">Reset view</button>
      <button id="export">Export visible JSON</button>
    </div>

    <div class="stat">Tip: drag to pan, wheel to zoom, Shift+drag to box-select.</div>

    <label>Mock data</label>
    <table id="dataTable" class="table">
      <thead>
        <tr>
          <th>Last Name</th><th>First Name</th><th>Email</th><th>City</th><th>Event/Connection</th><th>Organization</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="sigma" class="vis2d">
    <div id="stage"></div>
  </div>
</div>

<script type="module">
  import Graph from "https://cdn.jsdelivr.net/npm/graphology@0.25.4/+esm";
  import Sigma from "https://cdn.jsdelivr.net/npm/sigma@3.0.0/+esm";
  import FA2Layout from "https://cdn.jsdelivr.net/npm/graphology-layout-forceatlas2@0.10.1/worker.js/+esm";

  // ---- Mock rows (swap with your data later) ----
const rows = [
  { last:"Tangarife",   first:"Emma",        email:"ejtangarib@eafit.edu.co",         city:"Medellín", event:"Team", org:"" },
  { last:"Arango",      first:"Sara",        email:"sarangofc@gmail.com",             city:"Medellín", event:"Team", org:"" },
  { last:"Aristizábal", first:"Juan Sebastián", email:"jarist23@eafit.edu.co",        city:"Medellín", event:"Team", org:"" },
  { last:"Roldan",      first:"Maria Camila",email:"mcamirroldan@edgelands.institute",city:"Medellín", event:"Team", org:"" },
  { last:"Goi",         first:"Maria Andrea",email:"mariaandreagg@gmail.com",         city:"Medellín", event:"Team", org:"" },
  { last:"Zapata-Mazo", first:"Oswaldo",     email:"00zapataoswaldo00@gmail.com",     city:"Medellín", event:"Team", org:"" },

  { last:"Uribe",       first:"Santiago",    email:"santiago@edgelands.institute",    city:"Cúcuta",   event:"Team", org:"" },
  { last:"Alarcon",     first:"Veronica",    email:"vivianaveronicaasua@ufps.edu.co", city:"Cúcuta",   event:"Team", org:"Derecho a No Obedecer/Lead + Universidad FPS" },
  { last:"Boada",       first:"Andres",      email:"andres@edgelands.institute",      city:"Cúcuta",   event:"Team", org:"" },

  { last:"Tames de Sousa", first:"Angel",    email:"angel@edgelands.institute",       city:"Geneva",   event:"Team", org:"" },
  { last:"Bogdani",     first:"Klea",        email:"klea.bogdani@graduateinstitute.ch", city:"Geneva", event:"Team", org:"" },
  { last:"Cordy",       first:"Jeanne",      email:"jeanne.cordy@graduateinstitute.ch", city:"Geneva", event:"Team", org:"" },
  { last:"Deshusses",   first:"Paul",        email:"paul.deshusses@graduateinstitute.ch", city:"Geneva", event:"Team", org:"" },
  { last:"Garcia Vargas", first:"Laura",     email:"laura@edgelands.institute",       city:"Geneva",   event:"Team", org:"" },
  { last:"Hofmann",     first:"Fabian",      email:"fhofman@ethz.ch",                 city:"Geneva",   event:"Team", org:"" },

  { last:"Rappaz",      first:"Bernard",     email:"bernard.rappaz@proton.me",        city:"Geneva",   event:"Team", org:"" },
  { last:"Chepkemoi",   first:"Cynthia",     email:"cynthiachepkemoi57@gmail.com",    city:"Nairobi",  event:"Team", org:"" },
  { last:"Sambuli",     first:"Nanjira",     email:"email@nanjira.com",               city:"Nairobi",  event:"Team", org:"" },
  { last:"Gathecha",    first:"Vanessa",     email:"vanessa@edgelands.institute",     city:"Nairobi",  event:"Team", org:"" },
  { last:"Kithinji Muriuki", first:"Paul",   email:"paulk@edgelands.institute",       city:"Nairobi",  event:"Team", org:"" },
  { last:"Mwangala",    first:"George",      email:"mugageo@gmail.com",               city:"Nairobi",  event:"Team", org:"" },
  { last:"Tenca",       first:"Nicola",      email:"nicolatenca.com@gmail.com",       city:"Other/Global", event:"Team", org:"" },
  { last:"Alibhai",     first:"Nabila",      email:"alibhai.nabila@gmail.com",        city:"Other/Global", event:"Team", org:"" },
  { last:"Lozano",      first:"Flavia",      email:"flavia.lozano@gmail.com",         city:"Other/Global", event:"Team", org:"" },
  { last:"Guterman",    first:"Jamie",       email:"jamie@edgelands.institute",       city:"Other/Global", event:"Team", org:"" },
  { last:"Guzzo",       first:"Mateus",      email:"matguzzo@gmail.com",              city:"Other/Global", event:"Team", org:"" },
  { last:"Harder",      first:"Karin",       email:"karin.harder@khrealms.com",       city:"Other/Global", event:"Team", org:"" },
  { last:"Ros",         first:"Hélène",      email:"helene@edgelands.institute",      city:"Other/Global", event:"Team", org:"" },
  { last:"Zermatten",   first:"Sophie",      email:"sophie@edgelands.institute",      city:"Other/Global", event:"Team", org:"" },
  { last:"Lasso Harrier", first:"Adriana",   email:"adriana.lasso-harrier@boston.gov", city:"Other/Global", event:"Team", org:"" },
  { last:"Newman",      first:"Sara",        email:"snewman@metalab.harvard.edu",     city:"Other/Global", event:"Team", org:"" },
  { last:"Perrin",      first:"Benoit",      email:"benoitperrincreac@gmail.com",     city:"Other/Global", event:"Team", org:"" },
  { last:"Py",          first:"Aude",        email:"aude.py@hotmail.com",             city:"Other/Global", event:"Team", org:"" },

  { last:"Barabas",     first:"Chelsea",     email:"chelsea.barabas@gmail.com",       city:"Houston",  event:"Team", org:"" },
  { last:"Kumar",       first:"Krupali",     email:"krupalikumar@gmail.com",          city:"Houston",  event:"Team", org:"" },
  { last:"Joy",         first:"",            email:"miss.elefante@gmail.com",         city:"Houston",  event:"Team", org:"" },

  { last:"Botero",      first:"Beatriz",     email:"bboteroa@gmail.com",              city:"Board",    event:"Team", org:"" },
  { last:"Cepeda",      first:"Jesus",       email:"j@os.city",                       city:"Board",    event:"Team", org:"" },
  { last:"Daccord",     first:"Yves",        email:"yves@yvesdaccord.com",            city:"Board",    event:"Team", org:"" },
  { last:"Fischer",     first:"Philipp",     email:"pfischer@obersonabeles.com",      city:"Board",    event:"Team", org:"Assembly" },
  { last:"Schaad",      first:"Beatrice",    email:"bea.schaad@bluewin.ch",           city:"Board",    event:"Team", org:"" },
  { last:"Sawarschel",  first:"Marie-Claude",email:"sawer@bluewin.ch",                city:"Board",    event:"Team", org:"" },
  { last:"Rybak",       first:"R.T.",        email:"rtrybak@mplsfoundation.org",      city:"Board",    event:"Team", org:"" },
  { last:"Stojanovic",  first:"Aleksandar",  email:"aleksandar.stojanovic@museum.ch", city:"Board",    event:"Team", org:"" },
  { last:"Hufschmid",   first:"Pascal",      email:"p.hufschmid@redcrossmuseum.ch",   city:"Board",    event:"Team", org:"" },
  { last:"Kerimi",      first:"Danil",       email:"dkerimi@icloud.com",              city:"Board",    event:"Team", org:"" },
  { last:"Koek",        first:"Ariane",      email:"ariane@koek.com",                 city:"Board",    event:"Team", org:"" },
  { last:"Lee",         first:"Xiaodong",    email:"xiaodong.lee@me.com",             city:"Board",    event:"Team", org:"" },
  { last:"McClain-Nhlapo", first:"Charlotte", email:"cmcclainnlapo@worldbank.org",    city:"Board",    event:"Team", org:"" }
];

  // ---- Table ----
  const tbody = document.querySelector("#dataTable tbody");
  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.last}</td><td>${r.first}</td><td>${r.email}</td><td>${r.city}</td><td>${r.event}</td><td>${r.org}</td>`;
    tbody.appendChild(tr);
  });

  // ---- Graph ----
  const graph = new Graph();

  // Colors from CSS variables in brand.css
  const css = getComputedStyle(document.documentElement);
  function colorForCity(city) {
    const varName = `--city-${(city || '').toLowerCase().replace(/\s+/g,'')}`;
    const v = css.getPropertyValue(varName).trim();
    return v || css.getPropertyValue('--graph-node').trim() || '#00B08B';
  }
  const cities = [...new Set(rows.map(r => r.city))];
  const colorByCity = Object.fromEntries(cities.map(c => [c, colorForCity(c)]));

  rows.forEach((r, i) => {
    const id = "p" + (i+1);
    graph.addNode(id, {
      id,
      label: `${r.first} ${r.last}`,
      email: r.email,
      city: r.city,
      event: r.event,
      org: r.org,
      x: (Math.random()-0.5)*10,
      y: (Math.random()-0.5)*10,
      size: 3,
      color: colorByCity[r.city] || '#999'
    });
  });

  const container = document.getElementById("stage");
  const renderer = new Sigma(graph, container, { zIndex: true, renderEdgeLabels:false });

  // Layout
  const fa2 = new FA2Layout(graph, { settings: { gravity:1, slowDown:2 } });
  fa2.start(); setTimeout(()=>fa2.stop(), 3000);

  // --- UI
  const $edgeRule = document.getElementById("edgeRule");
  const $city = document.getElementById("cityFilter");
  const $orgQ = document.getElementById("orgSearch");
  const $counts = document.getElementById("counts");
  const $reset = document.getElementById("reset");
  const $export = document.getElementById("export");

  cities.sort().forEach(c => {
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = c; $city.appendChild(opt);
  });

  function rebuildEdges(kind) {
    graph.clearEdges();
    const ids = graph.nodes();

    if (kind === "random") {
      const m = Math.min(ids.length * 2, 600);
      const used = new Set();
      let tries = 0;
      while (used.size < m && tries < m*5) {
        const s = ids[Math.floor(Math.random()*ids.length)];
        const t = ids[Math.floor(Math.random()*ids.length)];
        const key = s < t ? (s + '|' + t) : (t + '|' + s);
        if (s!==t && !used.has(key)) { used.add(key); graph.addEdge(s, t, { kind, weight:1 }); }
        tries++;
      }
      return;
    }

    const keyAttr = kind === "city" ? "city" : kind === "org" ? "org" : "event";
    const groups = {};
    graph.forEachNode((n, a) => {
      const k = a[keyAttr] || "(none)";
      (groups[k] ??= []).push(n);
    });
    Object.values(groups).forEach(arr => {
      if (arr.length <= 20) {
        for (let i=0;i<arr.length;i++) for (let j=i+1;j<arr.length;j++) graph.addEdge(arr[i], arr[j], { kind, weight:1 });
      } else {
        for (let i=0;i<arr.length;i++) graph.addEdge(arr[i], arr[(i+1)%arr.length], { kind, weight:1 });
      }
    });
  }

  function applyReducers() {
    const city = $city.value.trim();
    const q = $orgQ.value.trim().toLowerCase();

    graph.forEachNode((n, a) => {
      const okCity = !city || a.city === city;
      const okOrg = !q || (a.org || '').toLowerCase().includes(q);
      const visible = okCity && okOrg;
      renderer.setNodeVisibility(n, visible);
    });

    graph.forEachEdge(e => {
      const [s,t] = graph.extremities(e);
      const vs = !!renderer.getNodeDisplayData(s);
      const vt = !!renderer.getNodeDisplayData(t);
      renderer.setEdgeVisibility(e, vs && vt);
    });

    let nVis=0, eVis=0;
    graph.forEachNode(n => { if (renderer.getNodeDisplayData(n)) nVis++; });
    graph.forEachEdge(e => { if (renderer.getEdgeDisplayData(e)) eVis++; });
    $counts.textContent = `Visible: ${nVis} nodes, ${eVis} edges`;
  }

  $edgeRule.onchange = () => { rebuildEdges($edgeRule.value); applyReducers(); };
  $city.onchange  = applyReducers;
  $orgQ.oninput   = applyReducers;
  $reset.onclick  = () => { renderer.getCamera().animatedReset(); $city.value=""; $orgQ.value=""; applyReducers(); };
  $export.onclick = () => {
    const visible = new Set();
    const nodes = [], edges = [];
    graph.forEachNode(n => { if (renderer.getNodeDisplayData(n)) visible.add(n); });
    graph.forEachNode(n => { if (visible.has(n)) nodes.push({ id:n, ...graph.getNodeAttributes(n) }); });
    graph.forEachEdge(e => {
      const [s,t] = graph.extremities(e);
      if (visible.has(s) && visible.has(t)) edges.push({ id:e, source:s, target:t, ...graph.getEdgeAttributes(e) });
    });
    const blob = new Blob([JSON.stringify({nodes, edges}, null, 2)], {type:"application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "filtered-graph.json"; a.click();
  };

  rebuildEdges($edgeRule.value);
  applyReducers();
</script>
</body>
</html>