<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>People Network (mock)</title>
  <style>
    html, body { margin:0; height:100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { display:grid; grid-template-columns: 320px 1fr; height:100%; }
    #left { padding:12px; border-right:1px solid #eee; overflow:auto; background: var(--panel-background, #ffffff); }
    #sigma.vis2d { position:relative; background: var(--graph-background, #ffffff); }
    #stage { position:absolute; inset:0; }
    h2.h2 { margin:0 0 10px; font-size:16px; font-weight:600; }
    label { display:block; font-weight:600; margin-top:10px; }
    select, input[type="text"] { width:100%; padding:6px; border:1px solid #ddd; border-radius:6px; }
    button { padding:6px 10px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer; }
    .row { display:flex; gap:8px; margin-top:10px; }
    .stat { color:#666; font-size:12px; margin-top:8px; }
    table.table { width:100%; border-collapse:collapse; font-size:12px; margin-top:10px; }
    table.table th, table.table td { border:1px solid #eee; padding:6px 8px; text-align:left; }
    table.table th { background:#fafafa; position:sticky; top:0; }
    .pill { display:inline-block; font-size:11px; border:1px solid #ddd; border-radius:999px; padding:2px 6px; margin-left:6px; }
  </style>

  <!-- Fonts + brand stylesheet -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="brand.css">
</head>
<body class="theme--formal">
<div id="app">
  <div id="left">
    <h2 class="h2">People Network (mock)</h2>
    <div class="stat" id="counts"></div>

    <label for="edgeRule">Edges</label>
    <select id="edgeRule">
      <option value="random">Random (demo)</option>
      <option value="city">Same City</option>
      <option value="org">Same Organization</option>
      <option value="event">Same Event/Connection</option>
    </select>

    <div class="row">
      <div style="flex:1;">
        <label for="cityFilter">Filter: City</label>
        <select id="cityFilter"><option value="">(all)</option></select>
      </div>
      <div style="flex:1;">
        <label for="orgSearch">Search: Organization</label>
        <input id="orgSearch" type="text" placeholder="type to filter…" />
      </div>
    </div>

    <div class="row">
      <button id="reset">Reset view</button>
      <button id="export">Export visible JSON</button>
    </div>

    <div class="stat">Tip: drag to pan, wheel to zoom, Shift+drag to box-select.</div>

    <label>Mock data</label>
    <table id="dataTable" class="table">
      <thead>
        <tr>
          <th>Last Name</th><th>First Name</th><th>Email</th><th>City</th><th>Event/Connection</th><th>Organization</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="sigma" class="vis2d">
    <div id="stage"></div>
  </div>
</div>

<script type="module">
  import Graph from "https://cdn.jsdelivr.net/npm/graphology@0.25.4/+esm";
  import Sigma from "https://cdn.jsdelivr.net/npm/sigma@3.0.0/+esm";
  import FA2Layout from "https://cdn.jsdelivr.net/npm/graphology-layout-forceatlas2@0.10.1/worker.js/+esm";

  // ---- Mock rows (swap with your data later) ----
  const rows = [
    {last:"Okello", first:"Amina", email:"amina.okello@example.org", city:"Nairobi", event:"Summit 2024",          org:"Open Energy Lab"},
    {last:"Mwangi", first:"David", email:"d.mwangi@example.org",      city:"Nairobi", event:"Workshop Kenya",       org:"Clean Power Fund"},
    {last:"Kamau",  first:"Lydia", email:"lydia.k@example.org",       city:"Nairobi", event:"Workshop Kenya",       org:"Urban Lab"},
    {last:"Otieno", first:"Brian", email:"b.otieno@example.org",      city:"Nairobi", event:"Panel on Grids",       org:"GridWorks Africa"},
    {last:"Cherono",first:"Faith", email:"faith.c@example.org",       city:"Nairobi", event:"Summit 2024",          org:"Ministry of Energy"},
    {last:"Rojas",  first:"Lucía", email:"lucia.r@example.org",       city:"Lima",    event:"Andes Energy Panel",   org:"Civic Data Co."},
    {last:"Mejía",  first:"Carlos",email:"cmejia@example.org",        city:"Lima",    event:"Andes Energy Panel",   org:"University Y"},
    {last:"Vega",   first:"Sofía", email:"s.vega@example.org",        city:"Lima",    event:"Solar Hackday",        org:"Energy Startup X"},
    {last:"García", first:"Ana",   email:"ana.g@example.org",         city:"Bogotá",  event:"Grid Interop",         org:"Ministry of Mines"},
    {last:"López",  first:"Mateo", email:"mateo.l@example.org",       city:"Bogotá",  event:"Grid Interop",         org:"Open Energy Lab"},
    {last:"Pardo",  first:"Nina",  email:"nina.p@example.org",        city:"Bogotá",  event:"Solar Hackday",        org:"Green NGO"},
    {last:"Boateng",first:"Kojo",  email:"k.boateng@example.org",     city:"Accra",   event:"West Africa Forum",    org:"Clean Power Fund"},
    {last:"Mensah", first:"Esi",   email:"esi.mensah@example.org",    city:"Accra",   event:"West Africa Forum",    org:"Ministry of Energy"},
    {last:"Gupta",  first:"Ken",   email:"ken.n@example.org",         city:"Nairobi", event:"Solar Hackday",        org:"Civic Data Co."},
    {last:"Mugo",   first:"Joy",   email:"joy.mugo@example.org",      city:"Nairobi", event:"Grid Interop",         org:"Open Energy Lab"},
    {last:"Castro", first:"Diego", email:"d.castro@example.org",      city:"Lima",    event:"Grid Interop",         org:"GridWorks Africa"},
    {last:"Torres", first:"María", email:"m.torres@example.org",      city:"Bogotá",  event:"Summit 2024",          org:"University Y"},
    {last:"Quaye",  first:"Ama",   email:"ama.quaye@example.org",     city:"Accra",   event:"Panel on Grids",       org:"Open Energy Lab"},
    {last:"Patel",  first:"Neel",  email:"neel.patel@example.org",    city:"Delhi",   event:"Solar Hackday",        org:"Green NGO"},
    {last:"Fernández",first:"Paz", email:"paz.f@example.org",         city:"Lima",    event:"Workshop Kenya",       org:"Ministry of Energy"},
    {last:"Ortiz",  first:"Juan",  email:"juan.ortiz@example.org",    city:"Bogotá",  event:"West Africa Forum",    org:"Power Access"},
    {last:"Yeboah", first:"Afua",  email:"afua.y@example.org",        city:"Accra",   event:"Andes Energy Panel",   org:"Urban Lab"},
    {last:"Gupta",  first:"Ravi",  email:"ravi.g@example.org",        city:"Delhi",   event:"Grid Interop",         org:"Civic Data Co."}
  ];

  // ---- Table ----
  const tbody = document.querySelector("#dataTable tbody");
  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.last}</td><td>${r.first}</td><td>${r.email}</td><td>${r.city}</td><td>${r.event}</td><td>${r.org}</td>`;
    tbody.appendChild(tr);
  });

  // ---- Graph ----
  const graph = new Graph();

  // Colors from CSS variables in brand.css
  const css = getComputedStyle(document.documentElement);
  function colorForCity(city) {
    const varName = `--city-\${(city || '').toLowerCase().replace(/\s+/g,'')}`;
    const v = css.getPropertyValue(varName).trim();
    return v || css.getPropertyValue('--graph-node').trim() || '#00B08B';
  }
  const cities = [...new Set(rows.map(r => r.city))];
  const colorByCity = Object.fromEntries(cities.map(c => [c, colorForCity(c)]));

  rows.forEach((r, i) => {
    const id = "p" + (i+1);
    graph.addNode(id, {
      id,
      label: `\${r.first} \${r.last}`,
      email: r.email,
      city: r.city,
      event: r.event,
      org: r.org,
      x: (Math.random()-0.5)*10,
      y: (Math.random()-0.5)*10,
      size: 3,
      color: colorByCity[r.city] || '#999'
    });
  });

  const container = document.getElementById("stage");
  const renderer = new Sigma(graph, container, { zIndex: true, renderEdgeLabels:false });

  // Layout
  const fa2 = new FA2Layout(graph, { settings: { gravity:1, slowDown:2 } });
  fa2.start(); setTimeout(()=>fa2.stop(), 3000);

  // --- UI
  const $edgeRule = document.getElementById("edgeRule");
  const $city = document.getElementById("cityFilter");
  const $orgQ = document.getElementById("orgSearch");
  const $counts = document.getElementById("counts");
  const $reset = document.getElementById("reset");
  const $export = document.getElementById("export");

  cities.sort().forEach(c => {
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = c; $city.appendChild(opt);
  });

  function rebuildEdges(kind) {
    graph.clearEdges();
    const ids = graph.nodes();

    if (kind === "random") {
      const m = Math.min(ids.length * 2, 600);
      const used = new Set();
      let tries = 0;
      while (used.size < m && tries < m*5) {
        const s = ids[Math.floor(Math.random()*ids.length)];
        const t = ids[Math.floor(Math.random()*ids.length)];
        const key = s<t ? `\${s}|\${t}\` : \`\${t}|\${s}`;
        if (s!==t && !used.has(key)) { used.add(key); graph.addEdge(s, t, { kind, weight:1 }); }
        tries++;
      }
      return;
    }

    const keyAttr = kind === "city" ? "city" : kind === "org" ? "org" : "event";
    const groups = {};
    graph.forEachNode((n, a) => {
      const k = a[keyAttr] || "(none)";
      (groups[k] ??= []).push(n);
    });
    Object.values(groups).forEach(arr => {
      if (arr.length <= 20) {
        for (let i=0;i<arr.length;i++) for (let j=i+1;j<arr.length;j++) graph.addEdge(arr[i], arr[j], { kind, weight:1 });
      } else {
        for (let i=0;i<arr.length;i++) graph.addEdge(arr[i], arr[(i+1)%arr.length], { kind, weight:1 });
      }
    });
  }

  function applyReducers() {
    const city = $city.value.trim();
    const q = $orgQ.value.trim().toLowerCase();

    graph.forEachNode((n, a) => {
      const okCity = !city || a.city === city;
      const okOrg = !q || (a.org || '').toLowerCase().includes(q);
      const visible = okCity && okOrg;
      renderer.setNodeVisibility(n, visible);
    });

    graph.forEachEdge(e => {
      const [s,t] = graph.extremities(e);
      const vs = !!renderer.getNodeDisplayData(s);
      const vt = !!renderer.getNodeDisplayData(t);
      renderer.setEdgeVisibility(e, vs && vt);
    });

    let nVis=0, eVis=0;
    graph.forEachNode(n => { if (renderer.getNodeDisplayData(n)) nVis++; });
    graph.forEachEdge(e => { if (renderer.getEdgeDisplayData(e)) eVis++; });
    $counts.textContent = `Visible: \${nVis} nodes, \${eVis} edges`;
  }

  $edgeRule.onchange = () => { rebuildEdges($edgeRule.value); applyReducers(); };
  $city.onchange  = applyReducers;
  $orgQ.oninput   = applyReducers;
  $reset.onclick  = () => { renderer.getCamera().animatedReset(); $city.value=""; $orgQ.value=""; applyReducers(); };
  $export.onclick = () => {
    const visible = new Set();
    const nodes = [], edges = [];
    graph.forEachNode(n => { if (renderer.getNodeDisplayData(n)) visible.add(n); });
    graph.forEachNode(n => { if (visible.has(n)) nodes.push({ id:n, ...graph.getNodeAttributes(n) }); });
    graph.forEachEdge(e => {
      const [s,t] = graph.extremities(e);
      if (visible.has(s) && visible.has(t)) edges.push({ id:e, source:s, target:t, ...graph.getEdgeAttributes(e) });
    });
    const blob = new Blob([JSON.stringify({nodes, edges}, null, 2)], {type:"application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "filtered-graph.json"; a.click();
  };

  rebuildEdges($edgeRule.value);
  applyReducers();
</script>
</body>
</html>