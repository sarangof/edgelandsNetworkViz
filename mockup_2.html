<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>3D People Network (mock)</title>
  <style>
    html, body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    #layout { display:grid; grid-template-columns: 340px 1fr; height:100%; }
    #left { border-right:1px solid #eee; padding:12px; overflow:auto; }
    #graph { position:relative; }
    #graph > div { position:absolute; inset:0; }
    h2 { margin:0 0 10px; font-size:16px; }
    label { display:block; margin-top:10px; font-weight:600; }
    select, input[type=text] { width:100%; padding:6px; border:1px solid #ddd; border-radius:6px; }
    button { padding:6px 10px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer; }
    .row { display:flex; gap:8px; margin-top:10px; align-items:center; }
    .stat { color:#666; font-size:12px; margin-top:8px; }
    table { width:100%; border-collapse:collapse; font-size:12px; margin-top:10px; }
    th, td { border:1px solid #eee; padding:6px 8px; text-align:left; }
    th { background:#fafafa; position:sticky; top:0; cursor:pointer; }
    tr.selected { background:#fff6d6; }
    .details { font-size:13px; border:1px solid #eee; border-radius:8px; padding:10px; margin-top:10px; background:#fafafa; }
    .muted { color:#777; font-size:12px; }
  </style>
</head>
<body>
<div id="layout">
  <div id="left">
    <h2>3D People Network (mock)</h2>
    <div class="stat" id="counts"></div>

    <label>Edges</label>
    <select id="edgeRule">
      <option value="random">Random (demo)</option>
      <option value="city">Same City</option>
      <option value="org">Same Organization</option>
      <option value="event">Same Event/Connection</option>
    </select>

    <div class="row">
      <div style="flex:1">
        <label>Filter: City</label>
        <select id="cityFilter"><option value="">(all)</option></select>
      </div>
      <div style="flex:1">
        <label>Search: Organization</label>
        <input id="orgSearch" type="text" placeholder="type to filter…"/>
      </div>
    </div>

    <div class="row">
      <button id="reset">Reset view</button>
      <button id="clearSel">Clear selection</button>
    </div>

    <div class="details" id="details">
      <div class="muted">Click a node or table row to see details here.</div>
    </div>

    <label style="margin-top:12px">Mock data</label>
    <table id="tbl">
      <thead>
      <tr>
        <th data-col="last">Last Name ▲▼</th>
        <th data-col="first">First Name ▲▼</th>
        <th data-col="email">Email ▲▼</th>
        <th data-col="city">City ▲▼</th>
        <th data-col="event">Event/Connection ▲▼</th>
        <th data-col="org">Organization ▲▼</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="graph"><div id="3d"></div></div>
</div>

<!-- 3D Force Graph (includes three.js) -->
<script src="https://unpkg.com/3d-force-graph"></script>
<script>
  // ---- Mock rows (swap with your real data later) ----
  const rows = [
    {last:"Okello", first:"Amina", email:"amina.okello@example.org", city:"Nairobi", event:"Summit 2024",        org:"Open Energy Lab"},
    {last:"Mwangi", first:"David", email:"d.mwangi@example.org",      city:"Nairobi", event:"Workshop Kenya",     org:"Clean Power Fund"},
    {last:"Kamau",  first:"Lydia", email:"lydia.k@example.org",       city:"Nairobi", event:"Workshop Kenya",     org:"Urban Lab"},
    {last:"Otieno", first:"Brian", email:"b.otieno@example.org",      city:"Nairobi", event:"Panel on Grids",     org:"GridWorks Africa"},
    {last:"Cherono",first:"Faith", email:"faith.c@example.org",       city:"Nairobi", event:"Summit 2024",        org:"Ministry of Energy"},
    {last:"Rojas",  first:"Lucía", email:"lucia.r@example.org",       city:"Lima",    event:"Andes Energy Panel", org:"Civic Data Co."},
    {last:"Mejía",  first:"Carlos",email:"cmejia@example.org",        city:"Lima",    event:"Andes Energy Panel", org:"University Y"},
    {last:"Vega",   first:"Sofía", email:"s.vega@example.org",        city:"Lima",    event:"Solar Hackday",      org:"Energy Startup X"},
    {last:"García", first:"Ana",   email:"ana.g@example.org",         city:"Bogotá",  event:"Grid Interop",       org:"Ministry of Mines"},
    {last:"López",  first:"Mateo", email:"mateo.l@example.org",       city:"Bogotá",  event:"Grid Interop",       org:"Open Energy Lab"},
    {last:"Pardo",  first:"Nina",  email:"nina.p@example.org",        city:"Bogotá",  event:"Solar Hackday",      org:"Green NGO"},
    {last:"Boateng",first:"Kojo",  email:"k.boateng@example.org",     city:"Accra",   event:"West Africa Forum",  org:"Clean Power Fund"},
    {last:"Mensah", first:"Esi",   email:"esi.mensah@example.org",    city:"Accra",   event:"West Africa Forum",  org:"Power Access"},
    {last:"Agyeman",first:"Yaw",   email:"yaw.agyeman@example.org",   city:"Accra",   event:"Solar Hackday",      org:"Tech & Grid"},
    {last:"Singh",  first:"Priya", email:"priya.singh@example.org",   city:"Delhi",   event:"India Renewables",   org:"Energy Startup X"},
    {last:"Sharma", first:"Arun",  email:"arun.sharma@example.org",   city:"Delhi",   event:"India Renewables",   org:"Ministry of Power"},
    {last:"Khan",   first:"Sara",  email:"sara.khan@example.org",     city:"Delhi",   event:"Panel on Grids",     org:"Urban Lab"},
    {last:"Njoroge",first:"Ken",   email:"ken.n@example.org",         city:"Nairobi", event:"Solar Hackday",      org:"Civic Data Co."},
    {last:"Mugo",   first:"Joy",   email:"joy.mugo@example.org",      city:"Nairobi", event:"Grid Interop",       org:"Open Energy Lab"},
    {last:"Castro", first:"Diego", email:"d.castro@example.org",      city:"Lima",    event:"Grid Interop",       org:"GridWorks Africa"},
    {last:"Torres", first:"María", email:"m.torres@example.org",      city:"Bogotá",  event:"Summit 2024",        org:"University Y"},
    {last:"Quaye",  first:"Ama",   email:"ama.quaye@example.org",     city:"Accra",   event:"Panel on Grids",     org:"Open Energy Lab"},
    {last:"Patel",  first:"Neel",  email:"neel.patel@example.org",    city:"Delhi",   event:"Solar Hackday",      org:"Green NGO"},
    {last:"Fernández",first:"Paz", email:"paz.f@example.org",         city:"Lima",    event:"Workshop Kenya",     org:"Ministry of Energy"},
    {last:"Ortiz",  first:"Juan",  email:"juan.ortiz@example.org",    city:"Bogotá",  event:"West Africa Forum",  org:"Power Access"},
    {last:"Yeboah", first:"Afua",  email:"afua.y@example.org",        city:"Accra",   event:"Andes Energy Panel", org:"Urban Lab"}
  ];

  // Build nodes
  const nodes = rows.map((r, i) => ({
    id: 'p' + (i+1),
    label: `${r.first} ${r.last}`,
    last: r.last, first: r.first, email: r.email,
    city: r.city, event: r.event, org: r.org
  }));

  // Color palette by city
  const palette = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
  const cities = [...new Set(rows.map(r => r.city))];
  const colorByCity = Object.fromEntries(cities.map((c,i)=>[c, palette[i % palette.length]]));

  // State
  let links = [];
  let selectedId = null;
  const visible = new Set(nodes.map(n => n.id));

  // HTML refs
  const $edgeRule = document.getElementById('edgeRule');
  const $city = document.getElementById('cityFilter');
  const $orgQ = document.getElementById('orgSearch');
  const $counts = document.getElementById('counts');
  const $reset = document.getElementById('reset');
  const $clearSel = document.getElementById('clearSel');
  const $tbody = document.querySelector('#tbl tbody');
  const $details = document.getElementById('details');

  // City filter options
  cities.sort().forEach(c => {
    const opt = document.createElement('option'); opt.value=c; opt.textContent=c; $city.appendChild(opt);
  });

  // --- Edge builders ---
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; }
  function addGroupLinks(ids, kind) {
    // For small groups: full clique; for bigger: ring + random chords
    if (ids.length <= 20) {
      for (let i=0;i<ids.length;i++) for (let j=i+1;j<ids.length;j++) links.push({source:ids[i], target:ids[j], kind});
    } else {
      const arr = shuffle([...ids]);
      for (let i=0;i<arr.length;i++) links.push({source:arr[i], target:arr[(i+1)%arr.length], kind});
      const extra = Math.min(arr.length * 2, 2000);
      for (let k=0;k<extra;k++){
        const s = arr[Math.floor(Math.random()*arr.length)];
        const t = arr[Math.floor(Math.random()*arr.length)];
        if (s!==t) links.push({source:s, target:t, kind});
      }
    }
  }
  function rebuildLinks(kind) {
    links = [];
    const ids = nodes.map(n => n.id);
    if (kind === 'random') {
      const m = Math.min(ids.length*2, 600);
      const used = new Set();
      for (let i=0;i<m;i++){
        const s = ids[Math.floor(Math.random()*ids.length)];
        const t = ids[Math.floor(Math.random()*ids.length)];
        const key = s<t ? s+'|'+t : t+'|'+s;
        if (s!==t && !used.has(key)){ used.add(key); links.push({source:s, target:t, kind}); }
      }
    } else {
      const keyAttr = kind==='city'?'city': kind==='org'?'org':'event';
      const groups = {};
      nodes.forEach(n => (groups[n[keyAttr]] ??= []).push(n.id));
      Object.values(groups).forEach(list => addGroupLinks(list, kind));
    }
  }

  // --- 3D graph ---
  const Graph = ForceGraph3D()(document.getElementById('3d'))
    .graphData({ nodes, links })
    .nodeId('id')
    .nodeLabel(n => `${n.label}\n${n.org} — ${n.city}`)
    .nodeVal(4)
    .nodeColor(n => (n.id===selectedId) ? '#ffd166' : colorByCity[n.city] || '#999')
    .linkColor(l => (l.source.id===selectedId || l.target.id===selectedId) ? '#ffd166' : 'rgba(180,180,180,0.6)')
    .linkOpacity(0.8)
    .linkDirectionalParticles(0)
    .nodeVisibility(n => visible.has(n.id))
    .linkVisibility(l => visible.has(l.source.id) && visible.has(l.target.id))
    .onNodeClick(n => selectNode(n.id, true))
    .onBackgroundClick(() => clearSelection());

  // Focus camera on node
  function flyToNode(n){
    const dist = 80;
    const distRatio = 1 + dist / Math.hypot(n.x, n.y, n.z || 1);
    Graph.cameraPosition(
      { x: n.x * distRatio, y: n.y * distRatio, z: (n.z||1) * distRatio },
      { x: n.x, y: n.y, z: n.z || 0 },
      1200
    );
  }

  // Selection + details + table sync
  function selectNode(id, fly=false){
    selectedId = id;
    const n = nodes.find(x => x.id===id);
    if (!n) return;
    // details
    $details.innerHTML = `
      <div><strong>${n.label}</strong></div>
      <div class="muted">${n.email}</div>
      <div>City: ${n.city}</div>
      <div>Event/Connection: ${n.event}</div>
      <div>Organization: ${n.org}</div>
    `;
    // highlight row
    [...$tbody.querySelectorAll('tr')].forEach(tr => tr.classList.toggle('selected', tr.dataset.id===id));
    // refresh colors/links
    Graph.nodeColor(Graph.nodeColor());
    Graph.linkColor(Graph.linkColor());
    if (fly) flyToNode(Graph.graphData().nodes.find(x => x.id===id) || n);
  }
  function clearSelection(){
    selectedId = null;
    $details.innerHTML = `<div class="muted">Click a node or table row to see details here.</div>`;
    [...$tbody.querySelectorAll('tr')].forEach(tr => tr.classList.remove('selected'));
    Graph.nodeColor(Graph.nodeColor());
    Graph.linkColor(Graph.linkColor());
  }

  // Filters
  function applyFilters(){
    const cityVal = $city.value;
    const q = ($orgQ.value || '').toLowerCase();
    visible.clear();
    nodes.forEach(n => {
      const okCity = !cityVal || n.city===cityVal;
      const okOrg = !q || (n.org || '').toLowerCase().includes(q);
      if (okCity && okOrg) visible.add(n.id);
    });
    Graph.nodeVisibility(Graph.nodeVisibility());
    Graph.linkVisibility(Graph.linkVisibility());
    renderTable(); updateCounts();
  }

  // Counts
  function updateCounts(){
    const visN = [...visible].length;
    const gd = Graph.graphData();
    const visE = gd.links.filter(l => visible.has(l.source.id||l.source) && visible.has(l.target.id||l.target)).length;
    $counts.textContent = `Nodes: ${visN}/${gd.nodes.length} • Edges: ${visE}/${gd.links.length} • Rule: ${$edgeRule.value}`;
  }

  // Table (sortable + clickable)
  let sortCol = 'last', sortDir = 1; // 1 asc, -1 desc
  function renderTable(){
    const arr = nodes.filter(n => visible.has(n.id)).slice().sort((a,b)=>{
      const A = (a[sortCol] || '').toString().toLowerCase();
      const B = (b[sortCol] || '').toString().toLowerCase();
      if (A<B) return -1*sortDir; if (A>B) return 1*sortDir; return 0;
    });
    $tbody.innerHTML = '';
    for (const n of arr){
      const tr = document.createElement('tr');
      tr.dataset.id = n.id;
      tr.innerHTML = `<td>${n.last}</td><td>${n.first}</td><td>${n.email}</td><td>${n.city}</td><td>${n.event}</td><td>${n.org}</td>`;
      tr.onclick = () => selectNode(n.id, true);
      if (n.id===selectedId) tr.classList.add('selected');
      $tbody.appendChild(tr);
    }
  }
  document.querySelectorAll('#tbl thead th').forEach(th=>{
    th.onclick = ()=>{
      const col = th.dataset.col;
      sortDir = (sortCol===col) ? -sortDir : 1;
      sortCol = col;
      renderTable();
    };
  });

  // UI bindings
  document.getElementById('edgeRule').onchange = ()=>{
    rebuildLinks($edgeRule.value);
    Graph.graphData({ nodes, links });
    applyFilters();
  };
  $city.onchange = applyFilters;
  $orgQ.oninput = applyFilters;
  $reset.onclick = ()=> Graph.zoomToFit(800);
  $clearSel.onclick = clearSelection;

  // Init
  rebuildLinks($edgeRule.value);
  Graph.graphData({ nodes, links });
  applyFilters();
  renderTable();
  updateCounts();
</script>
</body>
</html>
