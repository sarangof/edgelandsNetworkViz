<!-- =============================================
Edgelands People Network — OVERLAY UI REFACTOR
============================================= -->

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>EDGELANDS PEOPLE NETWORK</title>

  <!-- Brand + fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="brand.css">
  <link rel="stylesheet" href="app.css">

  <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
  <script src="https://unpkg.com/3d-force-graph"></script>
  <script src="https://unpkg.com/3d-force-graph"></script>
  <script>
  const CSV_DEFAULT_PATH='database_Sep10.csv';
  const HEADER_MAP={"event/ connection":"event","connection":"event","last name":"last","first name":"first","email":"email","edgelands project":"project","language":"language","edgelands experience":"experience","expertise":"expertise","city":"city"};
  const TOKEN_SPLIT=/[,;/|·]+/;
  const norm=s=>String(s||'').trim().toLowerCase().replace(/\s+|\/+ /g,' ');

  const IS_FILE_PROTOCOL = location.protocol === 'file:';

  function detectDelimiter(t){const f=t.split(/\r?\n/).find(l=>l.trim())||"";return ((f.match(/;/g)||[]).length>(f.match(/,/g)||[]).length)?';':','}
  function splitCSVLine(line,d){const o=[];let c='',q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(q){if(ch==='\"'){if(line[i+1]==='\"'){c+='\"';i++}else q=false}else c+=ch}else{if(ch==='\"')q=true;else if(ch===d){o.push(c);c=''}else c+=ch}}o.push(c);return o}
  function parseCSV(text){
    const d=detectDelimiter(text), lines=text.split(/\r?\n/).filter(l=>l.trim()); if(!lines.length) return [];
    const header=splitCSVLine(lines[0],d).map(h=>norm(h)), keyFor=header.map(h=>HEADER_MAP[h]||h.replace(/\s+/g,'_'));
    const rows=[]; for(let i=1;i<lines.length;i++){const cells=splitCSVLine(lines[i],d), obj={}; for(let c=0;c<header.length;c++){obj[keyFor[c]]=(cells[c]??'').trim()}
      obj.first=obj.first||''; obj.last=obj.last||''; obj.email=obj.email||''; obj.project=obj.project||''; obj.language=obj.language||''; obj.experience=obj.experience||''; obj.expertise=obj.expertise||''; obj.city=obj.city||''; obj.event=obj.event||''; obj.label=[obj.first,obj.last].filter(Boolean).join(' ').trim()||'(unnamed)'; obj.org=obj.project; rows.push(obj)}
    return rows
  }
  async function tryFetchCSV(p){ if (IS_FILE_PROTOCOL) return null; try{ const r=await fetch(p,{cache:'no-cache'}); if(!r.ok) throw 0; const t=await r.text(); const rows=parseCSV(t); if(!rows.length) throw 0; return rows; }catch{ return null } }
  function askUserForCSV(){ return new Promise(res=>{ const b=document.createElement('div'); b.className='box'; b.innerHTML='<div class="box-head"><button class="box-toggle" aria-expanded="true">Load CSV</button></div><div class="box-body"><div class="muted">Choose a CSV to load your data:</div></div>'; const input=document.createElement('input'); input.type='file'; input.accept='.csv'; input.style.marginTop='8px'; input.onchange=e=>{const f=e.target.files[0]; if(!f) return; const rdr=new FileReader(); rdr.onload=()=>{b.remove(); res(parseCSV(rdr.result))}; rdr.readAsText(f)}; b.querySelector('.box-body').appendChild(input); (document.body).prepend(b); }) }
  async function loadRows(){ const a=await tryFetchCSV(CSV_DEFAULT_PATH); if(a&&a.length) return a; return await askUserForCSV(); }

  // Brand tokens & palette
  const css=getComputedStyle(document.documentElement);
  const COL_NODE_DEFAULT = css.getPropertyValue('--graph-node').trim()||'#00B08B';
  const COL_SELECTED = '#FFFFFF';
  const MUTED_NODE   = '#2a2a2a';
  const MUTED_LINK   = '#141414';
  const BRAND_PALETTE = ['#335852','#70AF94','#D85751','#E2F16C','#473B36','#BCCFC8'];
  const colorMap = {project:new Map(), language:new Map(), event:new Map(), experience:new Map(), expertise:new Map(), fallback:new Map()};
  function getBrandColor(value, domain='fallback'){
    const key=(value||'').toLowerCase(); if(!key) return BRAND_PALETTE[0];
    const cmap=colorMap[domain]||colorMap.fallback; if(cmap.has(key)) return cmap.get(key);
    const col=BRAND_PALETTE[cmap.size % BRAND_PALETTE.length]; cmap.set(key,col); return col;
  }
  function cityTokenColor(city){ const v=css.getPropertyValue(`--city-${(city||'').toLowerCase().replace(/\s+/g,'')}`).trim(); return v || null; }
  function firstToken(v){ return (v||'').split(TOKEN_SPLIT).map(s=>s.trim()).filter(Boolean)[0] || '' }
  function primaryKeyForMode(n, mode){ switch (mode){ case 'city':return (n.city||'').trim(); case 'event':return (n.event||'').trim(); case 'project':return firstToken(n.project); case 'language':return firstToken(n.language); case 'experience':return firstToken(n.experience); case 'expertise':return firstToken(n.expertise); default:return ''; } }
  function colorForNodeKeyByMode(key){ switch (nodeColorMode){ case 'city':return cityTokenColor(key)||getBrandColor(key,'fallback'); case 'project':return getBrandColor(firstToken(key),'project'); case 'language':return getBrandColor(firstToken(key),'language'); case 'event':return getBrandColor(key,'event'); case 'experience':return getBrandColor(firstToken(key),'experience'); case 'expertise':return getBrandColor(firstToken(key),'expertise'); default:return COL_NODE_DEFAULT; } }
  function titleForMode(){ switch (nodeColorMode){ case 'city':return 'Nodes colored by: City'; case 'project':return 'Nodes colored by: Edgelands Project'; case 'language':return 'Nodes colored by: Language'; case 'event':return 'Nodes colored by: Connection'; case 'experience':return 'Nodes colored by: Edgelands Experience'; case 'expertise':return 'Nodes colored by: Expertise'; default:return 'Nodes colored by: None'; } }
  function facetKeyForColorMode(mode){ switch (mode){ case 'city':return 'city'; case 'project':return 'project'; case 'language':return 'language'; case 'event':return 'event'; case 'experience':return 'experience'; case 'expertise':return 'expertise'; default:return null; } }
  const LEGEND_MAX=5;

  function legendBuckets(nodes, activeIds){
    const all=new Map(), vis=new Map();
    for(const n of nodes){ const key=primaryKeyForMode(n,nodeColorMode); if(!key) continue; all.set(key,(all.get(key)||0)+1); if(activeIds.has(n.id)) vis.set(key,(vis.get(key)||0)+1); }
    const rows=[...all.entries()].map(([key,countAll])=>({key,label:key,countAll,countVis:vis.get(key)||0,color:colorForNodeKeyByMode(key)}));
    rows.sort((a,b)=> b.countAll - a.countAll || a.label.localeCompare(b.label));
    return rows;
  }
  function currentFacetSelection(facetKey){ const wrap=document.querySelector(`.facet[data-key="${facetKey}"]`); const sel=new Set(); if(!wrap) return sel; wrap.querySelectorAll('input[type="checkbox"]:checked').forEach(cb=>sel.add(cb.value)); return sel; }
  function legendRowIsChecked(facetKey, valueOrValues){ const sel=currentFacetSelection(facetKey); if(Array.isArray(valueOrValues)){ return valueOrValues.every(v=>sel.has(v)); } return sel.has(valueOrValues); }
  function setFacetValuesChecked(facetKey, values, checked){ const wrap=document.querySelector(`.facet[data-key="${facetKey}"]`); if(!wrap) return; const valueSet=new Set(values); wrap.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(!valueSet.has(cb.value)) return; const willChange=cb.checked!==!!checked; cb.checked=!!checked; if(willChange) cb.dispatchEvent(new Event('change',{bubbles:true})); }); }
  function renderLegend(nodes, activeIds){ const box=document.getElementById('legend'); if(!box) return; const facetKey=facetKeyForColorMode(nodeColorMode); const buckets=legendBuckets(nodes,activeIds); const room=Math.max(0,LEGEND_MAX); const showCount=Math.max(0,room-1); const showRows=buckets.slice(0,showCount); const otherRows=buckets.slice(showCount); const rowsHTML=showRows.map(b=>`<div class="row legend-item" data-key="${b.key}" style="cursor:pointer;"><span class="swatch" style="background:${b.color}"></span><span>${b.label}</span><span class="meta">${b.countVis}/${b.countAll}</span></div>`).join(''); const otherCount=otherRows.reduce((s,r)=>s+(r.countAll||0),0); const otherKeys=otherRows.map(r=>r.key); const otherHTML=otherRows.length?(()=>{ const checked=legendRowIsChecked(facetKey,otherKeys); return `<div class="row legend-item" data-other="1" data-keys='${JSON.stringify(otherKeys)}' style="cursor:pointer;"><span class="swatch" style="background:rgba(150,150,150,.6)"></span><span>Other</span><span class="meta">${otherCount}</span></div>`; })():''; box.innerHTML=`<div class="legend-head"><h3>${titleForMode()}</h3><button class="legend-close" aria-label="Close legend">×</button></div>${rowsHTML}${otherHTML}`; box.querySelector('.legend-close')?.addEventListener('click',(e)=>{e.stopPropagation(); setLegendVisible(false);}); box.querySelectorAll('.legend-item').forEach(row=>{ row.addEventListener('click',()=>{ const isOther=row.hasAttribute('data-other'); const values=isOther?JSON.parse(row.getAttribute('data-keys')||'[]'):[row.getAttribute('data-key')]; const facet=facetKeyForColorMode(nodeColorMode); if(!facet||values.length===0) return; const currentlyChecked=legendRowIsChecked(facet,values); setFacetValuesChecked(facet,values,!currentlyChecked); }); }); }
  function setLegendVisible(v){ const box=document.getElementById('legend'); const btn=document.getElementById('legendToggle'); if(!box||!btn) return; box.classList.toggle('is-hidden',!v); box.classList.toggle('is-shown',!!v); btn.setAttribute('aria-expanded',String(!!v)); localStorage.setItem('legend:visible',String(!!v)); }
  function getLegendInitialVisibility(){ const saved=localStorage.getItem('legend:visible'); if(saved!==null) return saved==='true'; return false; }
  </script>
</head>

<body class="theme--casual">
<div id="layout">

  <!-- Graph (dominant area) -->
  <div id="graph" class="vis3d">
    <div id="3d"></div>

    <!-- Floating toolbar (top) -->
    <div id="topToolbar" class="toolbar-floating">
      <div class="left-actions">
        <button id="randomViewBtn" class="btn-chip btn-accent">Random view</button>
        <button id="defaultViewBtn" class="btn-chip btn-accent">Default view</button>
      </div>
    <div class="right-actions">
      <button class="btn-chip btn-filter" data-open="coloring">Coloring</button>
      <button class="btn-chip btn-filter" data-open="edges">Edges</button>
    </div>

    </div>

    <!-- Overlay panels for controls -->
    <div id="overlay-filters" class="overlay-panel" hidden>
      <div class="overlay-head"><div class="title">Filters</div><button class="overlay-close" data-close>×</button></div>
      <div class="overlay-body">
        <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
          <button id="clearAllFilters" class="btn-chip">Clear all filters</button>
        </div>
        <div id="filters"></div>
      </div>
    </div>

    <div id="overlay-coloring" class="overlay-panel" hidden>
      <div class="overlay-head"><div class="title">Coloring</div><button class="overlay-close" data-close>×</button></div>
      <div class="overlay-body">
        <label style="margin-top:0">Node color by</label>
        <select id="nodeColorBy">
          <option value="city" selected>City</option>
          <option value="project">Edgelands Project</option>
          <option value="language">Language</option>
          <option value="event">Connection</option>
          <option value="experience">Edgelands Experience</option>
          <option value="expertise">Expertise</option>
          <option value="none">None (single)</option>
        </select>
      </div>
    </div>

    <div id="overlay-edges" class="overlay-panel" hidden>
      <div class="overlay-head"><div class="title">Edges</div><button class="overlay-close" data-close>×</button></div>
      <div class="overlay-body">
        <label>Mode</label>
        <select id="edgeMode">
          <option value="similarity" selected>Similarity (custom)</option>
          <option value="random">Random (demo)</option>
        </select>
        <div id="simOptions" style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Similarity fields (check to include)</div>
          <label class="row"><input type="checkbox" id="simChk-language"><span>Language</span></label>
          <label class="row"><input type="checkbox" id="simChk-project" checked><span>Edgelands Project</span></label>
          <label class="row"><input type="checkbox" id="simChk-city"><span>City</span></label>
          <label class="row"><input type="checkbox" id="simChk-expertise"><span>Expertise</span></label>
          <label class="row"><input type="checkbox" id="simChk-experience"><span>Edgelands Experience</span></label>
          <div class="row" style="align-items:center; gap:12px; margin-top:12px">
            <label style="margin:0; min-width:110px">Threshold</label>
            <input type="range" id="simThreshold" min="0" max="100" step="5" value="10">
            <div id="simThresholdLabel" style="width:40px; text-align:right">10%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Facet button rail (left-center of main view) -->
    <div id="facetBar" class="facet-bar"></div>

    <!-- Legend & floating actions -->
    <div id="legend" class="legend"></div>
    <button id="legendToggle" class="pill" aria-expanded="false" aria-controls="legend">Legend</button>

    <button id="resetFloating" class="pill">Reset view</button>
    <button id="clearSelFloating" class="pill">Clear selection</button>
    <button id="clearFiltersFloating" class="pill">Clear filters</button>

    <!-- Selection popups near nodes -->
    <div id="nodePopups" class="popups-layer"></div>

    <!-- Nav hint -->
    <div class="navinfo">Left click: rotate · Wheel/middle: zoom · Right click: pan</div>

 

  </div>

  <!-- Right panel → global search + active list as cards -->
  <div id="right" class="panel">
    <div class="frame-title">People</div>
    <div class="row" id="global-search-row" style="gap:8px; align-items:center; margin:8px 0">
      <input id="globalSearch" type="search" placeholder="Search all fields (e.g., Nairobi, data...)" style="flex:1; padding:6px 8px; border:1px solid #ccc; border-radius:8px; min-width:180px">
      <button id="clearSearch" type="button" title="Clear" style="padding:6px 10px; border:1px solid #ccc; border-radius:8px; background:#f7f7f7">×</button>
    </div>
    <div class="muted" id="counts" style="margin:6px 0 10px">Visible: —</div>
    <div id="cardsList" class="cards"></div>
  </div>

</div>

<script>
(async function boot(){
  const rows = await loadRows();
  const nodes = rows.map((r,i)=>({ id:'p'+(i+1), label:[r.first||'', r.last||''].filter(Boolean).join(' ').trim()||'(unnamed)', first:r.first||'', last:r.last||'', email:r.email||'', city:r.city||'', event:r.event||'', project:r.project||'', org:r.project||'', language:r.language||'', experience:r.experience||'', expertise:r.expertise||'' }));
  let links=[];
  const selectedIds=new Set();
  let lastClickedIndex=null; // used for range selections in list (kept for future)
  const activeIds=new Set();
  const neighborIds=new Set();

  // DOM refs
  const $graphWrap=document.getElementById('graph');
  const $legendToggle=document.getElementById('legendToggle');
  const $resetFloating=document.getElementById('resetFloating');
  const $clearSelFloating=document.getElementById('clearSelFloating');
  const $cardsList=document.getElementById('cardsList');
  const $counts=document.getElementById('counts');
  const $search=document.getElementById('globalSearch');
  const $clearSearch=document.getElementById('clearSearch');

  // Overlay refs
  const $overlayFilters=document.getElementById('overlay-filters');
  const $overlayColoring=document.getElementById('overlay-coloring');
  const $overlayEdges=document.getElementById('overlay-edges');
  const $filters=document.getElementById('filters');
  const $nodeColorBy=document.getElementById('nodeColorBy');
  const $edgeMode=document.getElementById('edgeMode');
  const $simOptions=document.getElementById('simOptions');
  const $th=document.getElementById('simThreshold');
  const $thLbl=document.getElementById('simThresholdLabel'); $thLbl.textContent=$th.value+'%';

  // Token sets for OR facets and similarity
  const tokenFacetKeys=new Set(['language','experience','expertise','project']);
  const nodeTokens={}; nodes.forEach(n=>{ nodeTokens[n.id]={}; for(const k of tokenFacetKeys){ nodeTokens[n.id][k]=new Set((n[k]||'').split(TOKEN_SPLIT).map(s=>s.trim()).filter(Boolean)); } });

  // 3D graph
  const world=ForceGraph3D()(document.getElementById('3d'))
    .graphData({nodes,links})
    .nodeId('id')
    .nodeLabel(n=>[n.label,[n.project,n.city].filter(Boolean).join(' — ')].filter(Boolean).join('\n'))
    .nodeRelSize(4)
    .nodeOpacity(0.95)
    .linkOpacity(0.18)
    .backgroundColor(getComputedStyle(document.body).getPropertyValue('--graph-background').trim()||'#0b0b0b')
    .onNodeClick(n=>toggleSelectById(n.id));
  world.onBackgroundClick(()=>{ selectedIds.clear(); lastClickedIndex=null; renderPopups(); applyFilters(); });
  world.showNavInfo(false);
  const resize=()=>{ world.width($graphWrap.clientWidth).height($graphWrap.clientHeight); }; new ResizeObserver(resize).observe($graphWrap); resize();

  function frameToBounds(mult=4.2){ const arr=world.graphData().nodes; if(!arr.length) return; let minX=+Infinity,minY=+Infinity,minZ=+Infinity,maxX=-Infinity,maxY=-Infinity,maxZ=-Infinity; arr.forEach(n=>{ minX=Math.min(minX,n.x||0); maxX=Math.max(maxX,n.x||0); minY=Math.min(minY,n.y||0); maxY=Math.max(maxY,n.y||0); minZ=Math.min(minZ,n.z||0); maxZ=Math.max(maxZ,n.z||0); }); const cx=(minX+maxX)/2, cy=(minY+maxY)/2, cz=(minZ+maxZ)/2; const rx=maxX-minX, ry=maxY-minY, rz=maxZ-minZ; const radius=Math.max(rx,ry,rz)/2 || 120; world.cameraPosition({x:cx+radius*mult, y:cy+radius*mult, z:cz+radius*mult}, {x:cx,y:cy,z:cz}, 800); }
  setTimeout(()=>frameToBounds(4.2),900);

  // Color state
  window.nodeColorMode='city';

  function recomputeNeighbors(){ neighborIds.clear(); if(selectedIds.size===0) return; for(const l of links){ const s=typeof l.source==='object'?l.source.id:l.source; const t=typeof l.target==='object'?l.target.id:l.target; if(selectedIds.has(s)) neighborIds.add(t); if(selectedIds.has(t)) neighborIds.add(s); } }
  function nodeColor(n){ if(selectedIds.has(n.id)) return COL_SELECTED; if(activeIds.has(n.id)||neighborIds.has(n.id)){ const key=primaryKeyForMode(n,nodeColorMode); switch(nodeColorMode){ case 'city':{const c=cityTokenColor(key); return c||getBrandColor(key,'fallback');} case 'project':return getBrandColor(key,'project'); case 'language':return getBrandColor(key,'language'); case 'event':return getBrandColor(key,'event'); case 'experience':return getBrandColor(key,'experience'); case 'expertise':return getBrandColor(key,'expertise'); default:return COL_NODE_DEFAULT; } } return MUTED_NODE; }
  function edgeColor(l){ const s=typeof l.source==='object'?l.source:nodes.find(n=>n.id===l.source); const t=typeof l.target==='object'?l.target:nodes.find(n=>n.id===l.target); const sId=s.id, tId=t.id; if(selectedIds.has(sId)||selectedIds.has(tId)) return COL_SELECTED; const bothActive=activeIds.has(sId)&&activeIds.has(tId); if(bothActive){ if(l.kind==='sim') return 'rgba(200,200,200,0.65)'; if(l.kind==='random') return 'rgba(150,150,150,0.45)'; return 'rgba(180,180,180,0.6)'; } return MUTED_LINK; }
  function applyColors(){ world.nodeColor(nodeColor); world.linkColor(edgeColor); world.linkWidth(l=>{ const sId=typeof l.source==='object'?l.source.id:l.source; const tId=typeof l.target==='object'?l.target.id:l.target; const touchesSel=selectedIds.has(sId)||selectedIds.has(tId); if(touchesSel) return 3.6+(l.score||0)*1.6; if(selectedIds.size) return 0.22; return 0.24; }); world.linkOpacity(l=>{ const sId=typeof l.source==='object'?l.source.id:l.source; const tId=typeof l.target==='object'?l.target.id:l.target; const touchesSel=selectedIds.has(sId)||selectedIds.has(tId); if(touchesSel) return 0.9; if(selectedIds.size) return 0.08; return 0.14; }); world.nodeOpacity(0.95); }

  // Edge building
  function getSimilaritySettings(){ const fields=[]; if(document.getElementById('simChk-language').checked) fields.push('language'); if(document.getElementById('simChk-project').checked) fields.push('project'); if(document.getElementById('simChk-city').checked) fields.push('city'); if(document.getElementById('simChk-expertise').checked) fields.push('expertise'); if(document.getElementById('simChk-experience').checked) fields.push('experience'); const threshold=(+$th.value)/100; return {fields,threshold}; }
  function jaccard(aSet,bSet){ if(!aSet.size&&!bSet.size) return NaN; let inter=0; if(aSet.size<bSet.size){ aSet.forEach(v=>{ if(bSet.has(v)) inter++; }); } else { bSet.forEach(v=>{ if(aSet.has(v)) inter++; }); } const union=new Set([...aSet,...bSet]).size; return union?inter/union:NaN; }
  function pairSimilarity(a,b,fields){ const scores=[]; for(const f of fields){ if(f==='city'){ const va=(a.city||'').trim(), vb=(b.city||'').trim(); if(va===''&&vb==='') continue; scores.push(va&&vb?(va===vb?1:0):0); } else { const A=nodeTokens[a.id][f]||new Set(), B=nodeTokens[b.id][f]||new Set(); const s=jaccard(A,B); if(!Number.isNaN(s)) scores.push(s); } } if(!scores.length) return 0; return scores.reduce((x,y)=>x+y,0)/scores.length; }
  function rebuildLinks(mode){ links=[]; if(mode==='random'){ const ids=nodes.map(n=>n.id); const m=Math.min(ids.length*2,600), used=new Set(); while(used.size<m){ const s=ids[Math.floor(Math.random()*ids.length)], t=ids[Math.floor(Math.random()*ids.length)]; if(s===t) continue; const key=s<t?`${s}|${t}`:`${t}|${s}`; if(!used.has(key)){ used.add(key); links.push({source:s,target:t,kind:'random'}) } } world.graphData({nodes,links}); applyFilters(); return; } const {fields,threshold}=getSimilaritySettings(); if(!fields.length){ world.graphData({nodes,links}); applyFilters(); return; } for(let i=0;i<nodes.length;i++){ for(let j=i+1;j<nodes.length;j++){ const a=nodes[i], b=nodes[j]; const score=pairSimilarity(a,b,fields); if(score>=threshold){ links.push({source:a.id,target:b.id,kind:'sim',score}); } } } world.graphData({nodes,links}); applyFilters(); }

  // Facets → moved into overlay
  const facetDefs=[ {title:'Connection', key:'event', tokenized:false}, {title:'Edgelands Project', key:'project', tokenized:true}, {title:'Language', key:'language', tokenized:true}, {title:'Edgelands Experience', key:'experience', tokenized:true}, {title:'Expertise', key:'expertise', tokenized:true}, {title:'City', key:'city', tokenized:false}, ];
  const selectedFacets=Object.fromEntries(facetDefs.map(f=>[f.key,new Set()]));
  function uniqueSortedValues(def){ const {key,tokenized}=def, values=new Set(); nodes.forEach(n=>{ const raw=(n[key]||'').trim(); if(!raw) return; if(tokenized) raw.split(TOKEN_SPLIT).forEach(p=>{ const t=p.trim(); if(t) values.add(t); }); else values.add(raw); }); return [...values].sort((a,b)=>a.localeCompare(b)); }
  function makeFacet(def){ const values=uniqueSortedValues(def); const wrap=document.createElement('div'); wrap.className='facet'; wrap.dataset.key=def.key; const header=document.createElement('div'); header.className='facet-header'; const title=document.createElement('div'); title.className='title'; title.textContent=def.title; const actions=document.createElement('div'); actions.className='actions'; const aAll=document.createElement('button'); aAll.type='button'; aAll.textContent='Select all'; const aClr=document.createElement('button'); aClr.type='button'; aClr.textContent='Clear'; actions.append(aAll,aClr); header.append(title,actions); const body=document.createElement('div'); body.className='facet-body'; const list=document.createElement('div'); list.className='facet-list'; values.forEach(v=>{ const id=`chk-${def.key}-${v.replace(/[^a-z0-9]+/gi,'').toLowerCase()}`; const row=document.createElement('label'); row.className='facet-item'; row.title=v; row.innerHTML=`<input type="checkbox" value="${v}" id="${id}"><span>${v}</span>`; list.appendChild(row); }); body.appendChild(list); wrap.append(header,body); $filters.appendChild(wrap); list.addEventListener('change',e=>{ if(e.target&&e.target.type==='checkbox'){ const val=e.target.value; if(e.target.checked) selectedFacets[def.key].add(val); else selectedFacets[def.key].delete(val); applyFilters(); }}); aAll.onclick=()=>{ list.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ cb.checked=true; selectedFacets[def.key].add(cb.value); }); applyFilters(); }; aClr.onclick=()=>{ list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); selectedFacets[def.key].clear(); applyFilters(); } }
  function buildFacets(){ $filters.innerHTML=''; facetDefs.forEach(makeFacet); }
  function rowPassesFacets(n){ for(const def of facetDefs){ const sel=selectedFacets[def.key]; if(sel.size===0) continue; if(def.tokenized){ const toks=nodeTokens[n.id][def.key]||new Set(); let hit=false; for(const w of sel){ if(toks.has(w)){ hit=true; break; } } if(!hit) return false; } else { const val=(n[def.key]||'').trim(); if(!sel.has(val)) return false; } } return true; }

  function createFacetBar(){
    const rail = document.getElementById('facetBar');
    if (!rail) return;
    rail.innerHTML = '';
    // Order matches your facets list
    const defs = [
      {title:'Connection', key:'event'},
      {title:'Edgelands Project', key:'project'},
      {title:'Language', key:'language'},
      {title:'Edgelands Experience', key:'experience'},
      {title:'Expertise', key:'expertise'},
      {title:'City', key:'city'}
    ];
    defs.forEach(def => {
      const b = document.createElement('button');
      b.className = 'btn-chip btn-facet';
      b.textContent = def.title;
      b.dataset.facet = def.key;
      b.onclick = () => {
        // show Filters overlay, but only the chosen facet inside it
        $overlayFilters.hidden = false;
        $filters.querySelectorAll('.facet').forEach(el => {
          el.style.display = (el.dataset.key === def.key) ? 'block' : 'none';
        });
        $overlayFilters.scrollTop = 0;
      };
      rail.appendChild(b);
    });
  }

  // Search
  let searchTerms=[]; function setSearchTerms(val){ searchTerms=String(val||'').toLowerCase().trim().split(/\s+/).filter(Boolean); }
  function debounce(fn,ms=150){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); }; }
  function rowMatchesSearch(node){ if(searchTerms.length===0) return true; const flatValues=(val)=>Array.isArray(val)?val:[val]; const haystack=Object.values(node).flatMap(flatValues).filter(v=>typeof v==='string'||typeof v==='number').join(' ').toLowerCase(); return searchTerms.every(t=>haystack.includes(t)); }
  $search?.addEventListener('input',debounce(e=>{ setSearchTerms(e.target.value); applyFilters(); },150));
  $clearSearch?.addEventListener('click',()=>{ $search.value=''; setSearchTerms(''); applyFilters(); });

  // Active list (right panel) → cards
  function renderCardsList(){ const rowsActive=nodes.filter(n=>activeIds.has(n.id)).sort((a,b)=> (a.last||'').localeCompare(b.last||'') || (a.first||'').localeCompare(b.first||'')); if(!rowsActive.length){ $cardsList.innerHTML='<div class="muted">No people match the current filters.</div>'; return; } $cardsList.innerHTML=rowsActive.map(n=>`<div class="person-card ${selectedIds.has(n.id)?'is-selected':''}" data-id="${n.id}"><div class="pc-name">${[n.first,n.last].filter(Boolean).join(' ')||'(unnamed)'}</div>${n.email?`<div class="pc-row"><a class="pc-email" href="mailto:${n.email}">${n.email}</a></div>`:''}<div class="pc-row">${[n.city,n.event].filter(Boolean).join(' · ')}</div>${n.project?`<div class="pc-row">${n.project}</div>`:''}<div class="pc-tags">${n.language?`Language: ${n.language}`:''}${n.language&&(n.experience||n.expertise)?' · ':''}${n.experience?`Exp: ${n.experience}`:''}${n.experience&&n.expertise?' · ':''}${n.expertise?`Expertise: ${n.expertise}`:''}</div></div>`).join(''); Array.from($cardsList.querySelectorAll('.person-card')).forEach((el)=>{ el.onclick=()=>{ const id=el.getAttribute('data-id'); toggleSelectById(id); }; }); }

  function updateCounts(){ const visN=activeIds.size||0; let visE=0; for(const l of links){ const s=typeof l.source==='object'?l.source.id:l.source; const t=typeof l.target==='object'?l.target.id:l.target; if(activeIds.has(s)&&activeIds.has(t)) visE++; } $counts.textContent=`Visible: ${visN} nodes, ${visE} edges`; }

  // Filtering/coloring pipeline
  function applyFilters(){ activeIds.clear(); nodes.forEach(n=>{ if(rowPassesFacets(n)&&rowMatchesSearch(n)) activeIds.add(n.id); }); recomputeNeighbors(); renderCardsList(); updateCounts(); applyColors(); renderLegend(nodes,activeIds); }

  // Selection popups near nodes (inside #graph)
  const $popups=document.getElementById('nodePopups');
  function popupHTML(n){ return `<div class="pc-name">${[n.first,n.last].filter(Boolean).join(' ')||'(unnamed)'}</div>${n.email?`<div class=\"pc-row\"><a class=\"pc-email\" href=\"mailto:${n.email}\">${n.email}</a></div>`:''}<div class="pc-row">${[n.city,n.event].filter(Boolean).join(' · ')}</div>${n.project?`<div class="pc-row">${n.project}</div>`:''}`; }
  function renderPopups(){ $popups.innerHTML=''; if(!selectedIds.size) return; const sel=[...selectedIds].map(id=>nodes.find(n=>n.id===id)).filter(Boolean); for(const n of sel){ const d=document.createElement('div'); d.className='node-popup'; d.dataset.id=n.id; d.innerHTML=popupHTML(n); $popups.appendChild(d); }
    requestAnimationFrame(updatePopupPositions);
  }
  function updatePopupPositions(){ const cam=world.camera(); const w=$graphWrap.clientWidth, h=$graphWrap.clientHeight; const proj=new THREE.Vector3(); $popups.querySelectorAll('.node-popup').forEach(el=>{ const id=el.dataset.id; const n=nodes.find(x=>x.id===id); if(!n) return; proj.set(n.x||0,n.y||0,n.z||0).project(cam); const x=(proj.x*0.5+0.5)*w; const y=(-proj.y*0.5+0.5)*h; const off=12; el.style.transform=`translate(${Math.round(x+off)}px, ${Math.round(y-off)}px)`; el.style.opacity=(proj.z>1||proj.z<-1)?'0':'1'; }); if(selectedIds.size) requestAnimationFrame(updatePopupPositions); }

  function toggleSelectById(id){ if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); renderPopups(); applyFilters(); }

  // Overlay wiring (toolbar buttons)
  document.querySelectorAll('.btn-filter').forEach(btn => {
    btn.addEventListener('click', () => {
      const which = btn.getAttribute('data-open');
      const panel = which === 'coloring' ? $overlayColoring : $overlayEdges;
      [$overlayColoring, $overlayEdges].forEach(p => p.hidden = true);
      panel.hidden = false;
      panel.focus();
    });
  });

  document.querySelectorAll('[data-close]').forEach(btn=>{ btn.addEventListener('click',()=>{ btn.closest('.overlay-panel').hidden=true; }); });

  // Quick view preset buttons
  document.getElementById('randomViewBtn').addEventListener('click',()=>{ $edgeMode.value='random'; $edgeMode.dispatchEvent(new Event('change')); });
  document.getElementById('defaultViewBtn').addEventListener('click',()=>{ $edgeMode.value='similarity'; $edgeMode.dispatchEvent(new Event('change')); });

  // Legend pill + keyboard
  $legendToggle.onclick=()=>{ const expanded=$legendToggle.getAttribute('aria-expanded')==='true'; setLegendVisible(!expanded); };
  document.addEventListener('keydown',(e)=>{ if(e.key.toLowerCase()==='l'&&!e.metaKey&&!e.ctrlKey&&!e.altKey){ e.preventDefault(); const expanded=$legendToggle.getAttribute('aria-expanded')==='true'; setLegendVisible(!expanded); } });

  // Floating actions
  function doReset(){ frameToBounds(4.2); selectedIds.clear(); lastClickedIndex=null; for(const def of facetDefs){ selectedFacets[def.key].clear(); const wrap=document.querySelector(`.facet[data-key="${def.key}"]`); if(wrap) wrap.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); } setSearchTerms(''); if($search) $search.value=''; renderPopups(); rebuildLinks($edgeMode.value); renderLegend(nodes,activeIds); }
  function doClearSel(){ selectedIds.clear(); lastClickedIndex=null; renderPopups(); applyFilters(); }
  document.getElementById('clearFiltersFloating').onclick=()=>{ for(const def of facetDefs){ selectedFacets[def.key].clear(); const wrap=document.querySelector(`.facet[data-key="${def.key}"]`); if(wrap) wrap.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); } setSearchTerms(''); if($search) $search.value=''; applyFilters(); };
  $resetFloating.onclick=doReset; $clearSelFloating.onclick=doClearSel;

  // Edge & coloring handlers
  $edgeMode.onchange=()=>{ const sim=$edgeMode.value==='similarity'; $simOptions.style.display=sim?'block':'none'; rebuildLinks($edgeMode.value); setLegendVisible(false); setLegendVisible(getLegendInitialVisibility()); };
  $th.oninput=()=>{ $thLbl.textContent=$th.value+'%'; rebuildLinks($edgeMode.value); };
  ;['language','project','city','expertise','experience'].forEach(k=>{ document.getElementById('simChk-'+k).onchange=()=>rebuildLinks($edgeMode.value); });
  document.getElementById('nodeColorBy').onchange=()=>{ window.nodeColorMode=$nodeColorBy.value; applyColors(); renderLegend(nodes,activeIds); setLegendVisible(true); };

  // Init
  buildFacets();
  createFacetBar(); 
  rebuildLinks('similarity');
  applyFilters();
  setLegendVisible(false);
})();
</script>
</body>
</html>

