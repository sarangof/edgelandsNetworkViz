<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>3D People Network (draft)</title>
<style>
  html, body { height:100%; margin:0; font-family: var(--font-sans, system-ui,-apple-system,Segoe UI,Roboto,sans-serif); }

  /* Layout */
  #layout {
    display:grid;
    grid-template-columns: 380px 1fr;
    column-gap: 16px;            /* spacing between left panel and graph */
    height:100%;
    padding:12px;                /* breathing room around the whole app */
    box-sizing: border-box;
    background: var(--app-bg);   /* from brand.css theme */
  }

  /* Left panel */
  #left {
    border:1px solid var(--app-border);
    border-radius: var(--radius);
    background: var(--app-surface);
    padding:12px;
    overflow:auto;               /* lets the table scroll instead of getting cut */
    box-shadow: var(--shadow);
  }
  h2.h2 { margin:0 0 10px; font-size:16px; font-weight:600; }
  label { display:block; margin-top:10px; font-weight:600; }
  select, input[type=text] {
    width:100%; padding:8px 10px;
    border:1px solid var(--app-border);
    border-radius:12px;
    background: var(--app-surface);
    color: var(--app-text);
  }
  button {
    padding:8px 12px; border-radius:999px;
    border:1px solid var(--app-border);
    background: transparent; color: var(--brand-accent);
    cursor:pointer;
  }
  .row { display:flex; gap:8px; margin-top:10px; align-items:center; }
  .stat { color: var(--col-muted); font-size:12px; margin-top:8px; }

  /* Graph area */
  #graph.vis3d {
    position:relative;
    background: var(--graph-background);
    border:1px solid var(--app-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    min-height: 560px;
  }
  #graph > div { position:absolute; inset:0; }

  /* Details block */
  .details {
    font-size:13px;
    border:1px solid var(--app-border);
    border-radius:12px;
    padding:10px;
    margin-top:10px;
    background: var(--app-surface);
  }
  .muted { color: var(--col-muted); font-size:12px; }

  /* Table */
  table.table {
    width:100%; border-collapse:collapse; font-size:12px; margin-top:10px;
    background: var(--app-surface); border:1px solid var(--app-border);
    border-radius: var(--radius); overflow: hidden;
  }
  table.table th, table.table td { border-top:1px solid var(--app-border); padding:6px 8px; text-align:left; }
  table.table thead th { background: rgba(255,255,255,.06); position:sticky; top:0; cursor:pointer; }
  tr.selected { background: rgba(218,243,0,.12); }
</style>


  <!-- Fonts + brand stylesheet -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="brand.css">
</head>
<body class="theme--casual">
<div id="layout">
  <div id="left">
    <h2 class="h2">3D People Network (mock)</h2>
    <div class="stat" id="counts"></div>

    <label>Edges</label>
    <select id="edgeRule">
      <option value="random">Random (demo)</option>
      <option value="city">Same City</option>
      <option value="org">Same Organization</option>
      <option value="event">Same Event/Connection</option>
    </select>

    <div class="row">
      <div style="flex:1">
        <label>Filter: City</label>
        <select id="cityFilter"><option value="">(all)</option></select>
      </div>
      <div style="flex:1">
        <label>Search: Organization</label>
        <input id="orgSearch" type="text" placeholder="type to filter…"/>
      </div>
    </div>

    <div class="row">
      <button id="reset">Reset view</button>
      <button id="clearSel">Clear selection</button>
    </div>

    <div class="details" id="details">
      <div class="muted">Click a node or table row to see details here.</div>
    </div>

    <label style="margin-top:12px">Table</label>
    <table id="tbl" class="table">
      <thead>
        <tr>
          <th data-col="last">Last Name ▲▼</th>
          <th data-col="first">First Name ▲▼</th>
          <th data-col="email">Email ▲▼</th>
          <th data-col="city">City ▲▼</th>
          <th data-col="event">Event/Connection ▲▼</th>
          <th data-col="org">Organization ▲▼</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="graph" class="vis3d"><div id="3d"></div></div>
</div>

<!-- 3D Force Graph (includes three.js) -->
<script src="https://unpkg.com/3d-force-graph"></script>
<script>
  // ---- Mock rows ----
const rows = [
  { last:"Tangarife",   first:"Emma",        email:"ejtangarib@eafit.edu.co",         city:"Medellín", event:"Team", org:"" },
  { last:"Arango",      first:"Sara",        email:"sarangofc@gmail.com",             city:"Medellín", event:"Team", org:"" },
  { last:"Aristizábal", first:"Juan Sebastián", email:"jarist23@eafit.edu.co",        city:"Medellín", event:"Team", org:"" },
  { last:"Roldan",      first:"Maria Camila",email:"mcamirroldan@edgelands.institute",city:"Medellín", event:"Team", org:"" },
  { last:"Goi",         first:"Maria Andrea",email:"mariaandreagg@gmail.com",         city:"Medellín", event:"Team", org:"" },
  { last:"Zapata-Mazo", first:"Oswaldo",     email:"00zapataoswaldo00@gmail.com",     city:"Medellín", event:"Team", org:"" },

  { last:"Uribe",       first:"Santiago",    email:"santiago@edgelands.institute",    city:"Cúcuta",   event:"Team", org:"" },
  { last:"Alarcon",     first:"Veronica",    email:"vivianaveronicaasua@ufps.edu.co", city:"Cúcuta",   event:"Team", org:"Derecho a No Obedecer/Lead + Universidad FPS" },
  { last:"Boada",       first:"Andres",      email:"andres@edgelands.institute",      city:"Cúcuta",   event:"Team", org:"" },

  { last:"Tames de Sousa", first:"Angel",    email:"angel@edgelands.institute",       city:"Geneva",   event:"Team", org:"" },
  { last:"Bogdani",     first:"Klea",        email:"klea.bogdani@graduateinstitute.ch", city:"Geneva", event:"Team", org:"" },
  { last:"Cordy",       first:"Jeanne",      email:"jeanne.cordy@graduateinstitute.ch", city:"Geneva", event:"Team", org:"" },
  { last:"Deshusses",   first:"Paul",        email:"paul.deshusses@graduateinstitute.ch", city:"Geneva", event:"Team", org:"" },
  { last:"Garcia Vargas", first:"Laura",     email:"laura@edgelands.institute",       city:"Geneva",   event:"Team", org:"" },
  { last:"Hofmann",     first:"Fabian",      email:"fhofman@ethz.ch",                 city:"Geneva",   event:"Team", org:"" },

  { last:"Rappaz",      first:"Bernard",     email:"bernard.rappaz@proton.me",        city:"Geneva",   event:"Team", org:"" },
  { last:"Chepkemoi",   first:"Cynthia",     email:"cynthiachepkemoi57@gmail.com",    city:"Nairobi",  event:"Team", org:"" },
  { last:"Sambuli",     first:"Nanjira",     email:"email@nanjira.com",               city:"Nairobi",  event:"Team", org:"" },
  { last:"Gathecha",    first:"Vanessa",     email:"vanessa@edgelands.institute",     city:"Nairobi",  event:"Team", org:"" },
  { last:"Kithinji Muriuki", first:"Paul",   email:"paulk@edgelands.institute",       city:"Nairobi",  event:"Team", org:"" },
  { last:"Mwangala",    first:"George",      email:"mugageo@gmail.com",               city:"Nairobi",  event:"Team", org:"" },

  { last:"Tenca",       first:"Nicola",      email:"nicolatenca.com@gmail.com",       city:"Other/Global", event:"Team", org:"" },
  { last:"Alibhai",     first:"Nabila",      email:"alibhai.nabila@gmail.com",        city:"Other/Global", event:"Team", org:"" },
  { last:"Lozano",      first:"Flavia",      email:"flavia.lozano@gmail.com",         city:"Other/Global", event:"Team", org:"" },
  { last:"Guterman",    first:"Jamie",       email:"jamie@edgelands.institute",       city:"Other/Global", event:"Team", org:"" },
  { last:"Guzzo",       first:"Mateus",      email:"matguzzo@gmail.com",              city:"Other/Global", event:"Team", org:"" },
  { last:"Harder",      first:"Karin",       email:"karin.harder@khrealms.com",       city:"Other/Global", event:"Team", org:"" },
  { last:"Ros",         first:"Hélène",      email:"helene@edgelands.institute",      city:"Other/Global", event:"Team", org:"" },
  { last:"Zermatten",   first:"Sophie",      email:"sophie@edgelands.institute",      city:"Other/Global", event:"Team", org:"" },
  { last:"Lasso Harrier", first:"Adriana",   email:"adriana.lasso-harrier@boston.gov", city:"Other/Global", event:"Team", org:"" },
  { last:"Newman",      first:"Sara",        email:"snewman@metalab.harvard.edu",     city:"Other/Global", event:"Team", org:"" },
  { last:"Perrin",      first:"Benoit",      email:"benoitperrincreac@gmail.com",     city:"Other/Global", event:"Team", org:"" },
  { last:"Py",          first:"Aude",        email:"aude.py@hotmail.com",             city:"Other/Global", event:"Team", org:"" },

  { last:"Barabas",     first:"Chelsea",     email:"chelsea.barabas@gmail.com",       city:"Houston",  event:"Team", org:"" },
  { last:"Kumar",       first:"Krupali",     email:"krupalikumar@gmail.com",          city:"Houston",  event:"Team", org:"" },
  { last:"Joy",         first:"",            email:"miss.elefante@gmail.com",         city:"Houston",  event:"Team", org:"" },

  { last:"Botero",      first:"Beatriz",     email:"bboteroa@gmail.com",              city:"Board",    event:"Team", org:"" },
  { last:"Cepeda",      first:"Jesus",       email:"j@os.city",                       city:"Board",    event:"Team", org:"" },
  { last:"Daccord",     first:"Yves",        email:"yves@yvesdaccord.com",            city:"Board",    event:"Team", org:"" },
  { last:"Fischer",     first:"Philipp",     email:"pfischer@obersonabeles.com",      city:"Board",    event:"Team", org:"Assembly" },
  { last:"Schaad",      first:"Beatrice",    email:"bea.schaad@bluewin.ch",           city:"Board",    event:"Team", org:"" },
  { last:"Sawarschel",  first:"Marie-Claude",email:"sawer@bluewin.ch",                city:"Board",    event:"Team", org:"" },
  { last:"Rybak",       first:"R.T.",        email:"rtrybak@mplsfoundation.org",      city:"Board",    event:"Team", org:"" },
  { last:"Stojanovic",  first:"Aleksandar",  email:"aleksandar.stojanovic@museum.ch", city:"Board",    event:"Team", org:"" },
  { last:"Hufschmid",   first:"Pascal",      email:"p.hufschmid@redcrossmuseum.ch",   city:"Board",    event:"Team", org:"" },
  { last:"Kerimi",      first:"Danil",       email:"dkerimi@icloud.com",              city:"Board",    event:"Team", org:"" },
  { last:"Koek",        first:"Ariane",      email:"ariane@koek.com",                 city:"Board",    event:"Team", org:"" },
  { last:"Lee",         first:"Xiaodong",    email:"xiaodong.lee@me.com",             city:"Board",    event:"Team", org:"" },
  { last:"McClain-Nhlapo", first:"Charlotte", email:"cmcclainnlapo@worldbank.org",    city:"Board",    event:"Team", org:"" }
];

  const nodes = rows.map((r, i) => ({
    id: 'p' + (i+1),
    label: `${r.first} ${r.last}`,
    last: r.last, first: r.first, email: r.email,
    city: r.city, event: r.event, org: r.org
  }));
  let links = [];
  let selectedId = null;
  const visible = new Set(nodes.map(n => n.id));

  // HTML refs
  const $edgeRule = document.getElementById('edgeRule');
  const $city = document.getElementById('cityFilter');
  const $orgQ = document.getElementById('orgSearch');
  const $counts = document.getElementById('counts');
  const $reset = document.getElementById('reset');
  const $clearSel = document.getElementById('clearSel');
  const $tbody = document.querySelector('#tbl tbody');
  const $details = document.getElementById('details');

  // City options
  const cities = [...new Set(rows.map(r => r.city))].sort();
  cities.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; $city.appendChild(o); });

  // Colors from CSS variables
  const css = getComputedStyle(document.documentElement);
  const COL_NODE = css.getPropertyValue('--graph-node').trim() || '#00B08B';
  const COL_SEL  = css.getPropertyValue('--graph-node-selected').trim() || '#DAF300';
  const COL_LINK = css.getPropertyValue('--graph-link').trim() || 'rgba(180,180,180,0.6)';
  function colorForCity(city) {
    const varName = `--city-${(city || '').toLowerCase().replace(/\s+/g,'')}`;
    const v = css.getPropertyValue(varName).trim();
    return v || COL_NODE;
  }

  // Table + sorting
  let sortCol = 'last', sortAsc = true;
  function renderTable() {
    const q = $orgQ.value.trim().toLowerCase();
    const city = $city.value;
    const arr = nodes
      .filter(n => (!city || n.city===city) && (!q || (n.org||'').toLowerCase().includes(q)))
      .sort((a,b)=> (a[sortCol] > b[sortCol] ? (sortAsc?1:-1) : (sortAsc?-1:1)));
    $tbody.innerHTML = '';
    arr.forEach(n => {
      const tr = document.createElement('tr');
      tr.dataset.id = n.id;
      tr.innerHTML = `<td>${n.last}</td><td>${n.first}</td><td>${n.email}</td><td>${n.city}</td><td>${n.event}</td><td>${n.org}</td>`;
      tr.onclick = () => focusNode(n.id);
      if (n.id===selectedId) tr.classList.add('selected');
      $tbody.appendChild(tr);
    });
  }
  renderTable();
  document.querySelectorAll('th[data-col]').forEach(th=>{
    th.onclick = ()=>{ const c=th.dataset.col; sortAsc = (sortCol===c)? !sortAsc : true; sortCol=c; renderTable(); };
  });

  // Edge builders
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; }
  function addGroupLinks(ids, kind) {
    if (ids.length <= 20) {
      for (let i=0;i<ids.length;i++) for (let j=i+1;j<ids.length;j++) links.push({source:ids[i], target:ids[j], kind});
    } else {
      const arr = shuffle(ids.slice());
      for (let i=0;i<arr.length;i++) links.push({source:arr[i], target:arr[(i+1)%arr.length], kind});
      const extra = Math.min(arr.length * 2, 1000);
      for (let k=0;k<extra;k++){
        const s = arr[Math.floor(Math.random()*arr.length)];
        const t = arr[Math.floor(Math.random()*arr.length)];
        if (s!==t) links.push({source:s, target:t, kind});
      }
    }
  }
  function rebuildLinks(kind) {
    links = [];
    const ids = nodes.map(n => n.id);
    if (kind === 'random') {
      const m = Math.min(ids.length*2, 600);
      const used = new Set();
      while (used.size < m) {
        const s = ids[Math.floor(Math.random()*ids.length)];
        const t = ids[Math.floor(Math.random()*ids.length)];
        const key = s < t ? (s + '|' + t) : (t + '|' + s);
        if (s!==t && !used.has(key)){ used.add(key); links.push({source:s, target:t, kind}); }
      }
    } else {
      const keyAttr = kind==='city'?'city': kind==='org'?'org':'event';
      const groups = {};
      nodes.forEach(n => (groups[n[keyAttr]] ??= []).push(n.id));
      Object.values(groups).forEach(list => addGroupLinks(list, kind));
    }
  }

  // 3D Graph
  // 3D Graph
  const world = ForceGraph3D()(document.getElementById('3d'))
    .graphData({ nodes, links })
    .nodeId('id')
    .nodeLabel(n => `${n.label}\n${n.org} — ${n.city}`)
    .nodeRelSize(4)
    .nodeOpacity(0.9)
    .linkOpacity(0.6)
    .linkWidth(1)
    .backgroundColor(
      getComputedStyle(document.body).getPropertyValue('--graph-background').trim() || '#0e2e37'
    )
    .nodeColor(n => (n.id === selectedId) ? COL_SEL : colorForCity(n.city))
    .linkColor(l => (l.source.id === selectedId || l.target.id === selectedId) ? COL_SEL : COL_LINK)
    .onNodeClick(n => focusNode(n.id));


  function refit() { world.graphData({ nodes: nodes, links: links }); updateCounts(); }
  function focusNode(id) {
    selectedId = id;
    const n = nodes.find(x => x.id===id);
    if (!n) return;
    document.getElementById('details').innerHTML = `
      <div><strong>${n.first} ${n.last}</strong></div>
      <div class="muted">${n.email}</div>
      <div>${n.city} · ${n.event}</div>
      <div>${n.org}</div>`;
    // refresh colors
    world.nodeColor(world.nodeColor());
    world.linkColor(world.linkColor());
  }
  function updateCounts(){
    const visN = nodes.filter(n => visible.has(n.id)).length;
    const visE = links.filter(l => visible.has(l.source.id||l.source) && visible.has(l.target.id||l.target)).length;
    $counts.textContent = `Visible: ${visN} nodes, ${visE} edges`;
  }
  updateCounts();

  // Filters
  function applyFilters(){
    visible.clear();
    const city = $city.value;
    const q = $orgQ.value.trim().toLowerCase();
    nodes.forEach(n => {
      const okCity = !city || n.city===city;
      const okOrg = !q || (n.org||'').toLowerCase().includes(q);
      if (okCity && okOrg) visible.add(n.id);
    });
    // hide nodes/links by filtering graphData
    const filtered = {
      nodes: nodes.filter(n => visible.has(n.id)),
      links: links.filter(l => visible.has(l.source.id||l.source) && visible.has(l.target.id||l.target))
    };
    world.graphData(filtered);
    renderTable(); updateCounts();
  }

  // Table
  function renderTable(){
    const arr = nodes.filter(n => visible.has(n.id))
      .sort((a,b)=> (a[sortCol] > b[sortCol] ? (sortAsc?1:-1) : (sortAsc?-1:1)));
    const $tbody = document.querySelector('#tbl tbody');
    $tbody.innerHTML = '';
    arr.forEach(n => {
      const tr = document.createElement('tr');
      tr.dataset.id = n.id;
      tr.innerHTML = `<td>${n.last}</td><td>${n.first}</td><td>${n.email}</td><td>${n.city}</td><td>${n.event}</td><td>${n.org}</td>`;
      tr.onclick = () => focusNode(n.id);
      $tbody.appendChild(tr);
    });
  }
  document.querySelectorAll('#tbl thead th').forEach(th=>{
    th.onclick = ()=>{ const c=th.dataset.col; sortAsc = (sortCol===c)? !sortAsc : true; sortCol=c; renderTable(); };
  });

  // UI
  $edgeRule.onchange = ()=>{ rebuildLinks($edgeRule.value); applyFilters(); };
  $city.onchange     = applyFilters;
  $orgQ.oninput      = applyFilters;
  $reset.onclick     = ()=>{ world.zoomToFit(400); $city.value=""; $orgQ.value=""; applyFilters(); };
  $clearSel.onclick  = ()=>{ selectedId=null; document.getElementById('details').innerHTML='<div class="muted">Click a node or table row to see details here.</div>'; world.nodeColor(world.nodeColor()); world.linkColor(world.linkColor()); };

  // Init
  rebuildLinks($edgeRule.value);
  applyFilters();
  renderTable();
</script>
</body>
</html>