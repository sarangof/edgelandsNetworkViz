<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>People Network (Mock)</title>
  <style>
    html, body { margin:0; height:100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { display:grid; grid-template-columns: 320px 1fr; height:100%; }
    #left { padding:12px; border-right:1px solid #eee; overflow:auto; }
    #sigma { position:relative; }
    #stage { position:absolute; inset:0; }
    h2 { margin:0 0 10px; font-size:16px; }
    label { display:block; font-weight:600; margin-top:10px; }
    select, input[type="text"] { width:100%; padding:6px; border:1px solid #ddd; border-radius:6px; }
    button { padding:6px 10px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer; }
    .row { display:flex; gap:8px; margin-top:10px; }
    .stat { color:#666; font-size:12px; margin-top:8px; }
    table { width:100%; border-collapse:collapse; font-size:12px; margin-top:10px; }
    th, td { border:1px solid #eee; padding:6px 8px; text-align:left; }
    th { background:#fafafa; position:sticky; top:0; }
    .pill { display:inline-block; font-size:11px; border:1px solid #ddd; border-radius:999px; padding:2px 6px; margin-left:6px; }
  </style>
</head>
<body>
<div id="app">
  <div id="left">
    <h2>People Network (mock)</h2>
    <div class="stat" id="counts"></div>

    <label for="edgeRule">Edges</label>
    <select id="edgeRule">
      <option value="random">Random (demo)</option>
      <option value="city">Same City</option>
      <option value="org">Same Organization</option>
      <option value="event">Same Event/Connection</option>
    </select>

    <div class="row">
      <div style="flex:1;">
        <label for="cityFilter">Filter: City</label>
        <select id="cityFilter"><option value="">(all)</option></select>
      </div>
      <div style="flex:1;">
        <label for="orgSearch">Search: Organization</label>
        <input id="orgSearch" type="text" placeholder="type to filter…" />
      </div>
    </div>

    <div class="row">
      <button id="reset">Reset view</button>
      <button id="export">Export visible JSON</button>
    </div>

    <div class="stat">Tip: drag to pan, wheel to zoom, Shift+drag to box-select.</div>

    <label>Mock data</label>
    <table id="dataTable">
      <thead>
        <tr>
          <th>Last Name</th><th>First Name</th><th>Email</th><th>City</th><th>Event/Connection</th><th>Organization</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="sigma">
    <div id="stage"></div>
  </div>
</div>

<script type="module">
  import Graph from "https://cdn.jsdelivr.net/npm/graphology@0.25.4/+esm";
  import Sigma from "https://cdn.jsdelivr.net/npm/sigma@3.0.0/+esm";
  import FA2Layout from "https://cdn.jsdelivr.net/npm/graphology-layout-forceatlas2@0.10.1/worker.js/+esm";

  // ---- Mock rows (you can swap these for your real CSV later) ----
  const rows = [
    {last:"Okello", first:"Amina", email:"amina.okello@example.org", city:"Nairobi", event:"Summit 2024",          org:"Open Energy Lab"},
    {last:"Mwangi", first:"David", email:"d.mwangi@example.org",      city:"Nairobi", event:"Workshop Kenya",       org:"Clean Power Fund"},
    {last:"Kamau",  first:"Lydia", email:"lydia.k@example.org",       city:"Nairobi", event:"Workshop Kenya",       org:"Urban Lab"},
    {last:"Otieno", first:"Brian", email:"b.otieno@example.org",      city:"Nairobi", event:"Panel on Grids",       org:"GridWorks Africa"},
    {last:"Cherono",first:"Faith", email:"faith.c@example.org",       city:"Nairobi", event:"Summit 2024",          org:"Ministry of Energy"},
    {last:"Rojas",  first:"Lucía", email:"lucia.r@example.org",       city:"Lima",    event:"Andes Energy Panel",   org:"Civic Data Co."},
    {last:"Mejía",  first:"Carlos",email:"cmejia@example.org",        city:"Lima",    event:"Andes Energy Panel",   org:"University Y"},
    {last:"Vega",   first:"Sofía", email:"s.vega@example.org",        city:"Lima",    event:"Solar Hackday",        org:"Energy Startup X"},
    {last:"García", first:"Ana",   email:"ana.g@example.org",         city:"Bogotá",  event:"Grid Interop",         org:"Ministry of Mines"},
    {last:"López",  first:"Mateo", email:"mateo.l@example.org",       city:"Bogotá",  event:"Grid Interop",         org:"Open Energy Lab"},
    {last:"Pardo",  first:"Nina",  email:"nina.p@example.org",        city:"Bogotá",  event:"Solar Hackday",        org:"Green NGO"},
    {last:"Boateng",first:"Kojo",  email:"k.boateng@example.org",     city:"Accra",   event:"West Africa Forum",    org:"Clean Power Fund"},
    {last:"Mensah", first:"Esi",   email:"esi.mensah@example.org",    city:"Accra",   event:"West Africa Forum",    org:"Power Access"},
    {last:"Agyeman",first:"Yaw",   email:"yaw.agyeman@example.org",   city:"Accra",   event:"Solar Hackday",        org:"Tech & Grid"},
    {last:"Singh",  first:"Priya", email:"priya.singh@example.org",   city:"Delhi",   event:"India Renewables",     org:"Energy Startup X"},
    {last:"Sharma", first:"Arun",  email:"arun.sharma@example.org",   city:"Delhi",   event:"India Renewables",     org:"Ministry of Power"},
    {last:"Khan",   first:"Sara",  email:"sara.khan@example.org",     city:"Delhi",   event:"Panel on Grids",       org:"Urban Lab"},
    {last:"Njoroge",first:"Ken",   email:"ken.n@example.org",         city:"Nairobi", event:"Solar Hackday",        org:"Civic Data Co."},
    {last:"Mugo",   first:"Joy",   email:"joy.mugo@example.org",      city:"Nairobi", event:"Grid Interop",         org:"Open Energy Lab"},
    {last:"Castro", first:"Diego", email:"d.castro@example.org",      city:"Lima",    event:"Grid Interop",         org:"GridWorks Africa"},
    {last:"Torres", first:"María", email:"m.torres@example.org",      city:"Bogotá",  event:"Summit 2024",          org:"University Y"},
    {last:"Quaye",  first:"Ama",   email:"ama.quaye@example.org",     city:"Accra",   event:"Panel on Grids",       org:"Open Energy Lab"},
    {last:"Patel",  first:"Neel",  email:"neel.patel@example.org",    city:"Delhi",   event:"Solar Hackday",        org:"Green NGO"},
    {last:"Fernández",first:"Paz", email:"paz.f@example.org",         city:"Lima",    event:"Workshop Kenya",       org:"Ministry of Energy"},
    {last:"Ortiz",  first:"Juan",  email:"juan.ortiz@example.org",    city:"Bogotá",  event:"West Africa Forum",    org:"Power Access"},
    {last:"Yeboah", first:"Afua",  email:"afua.y@example.org",        city:"Accra",   event:"Andes Energy Panel",   org:"Urban Lab"},
    {last:"Gupta",  first:"Ravi",  email:"ravi.g@example.org",        city:"Delhi",   event:"Grid Interop",         org:"Civic Data Co."}
  ];

  // ---- Fill table ----
  const tbody = document.querySelector("#dataTable tbody");
  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.last}</td><td>${r.first}</td><td>${r.email}</td><td>${r.city}</td><td>${r.event}</td><td>${r.org}</td>`;
    tbody.appendChild(tr);
  });

  // ---- Init graph ----
  const graph = new Graph();
  // color by city
  const palette = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
  const cities = [...new Set(rows.map(r => r.city))];
  const colorByCity = Object.fromEntries(cities.map((c,i)=>[c, palette[i % palette.length]]));

  rows.forEach((r, i) => {
    const id = "p" + (i+1);
    graph.addNode(id, {
      id,
      label: `${r.first} ${r.last}`,
      email: r.email,
      city: r.city,
      event: r.event,
      org: r.org,
      x: (Math.random()-0.5)*10,
      y: (Math.random()-0.5)*10,
      size: 3,
      color: colorByCity[r.city] || "#999"
    });
  });

  const container = document.getElementById("stage");
  const renderer = new Sigma(graph, container, { zIndex: true, renderEdgeLabels:false });

  // Run ForceAtlas2 for a few seconds to make it pretty
  const fa2 = new FA2Layout(graph, { settings: { gravity:1, slowDown:2 } });
  fa2.start(); setTimeout(()=>fa2.stop(), 3000);

  // ---- UI: edge rules & filters ----
  const $edgeRule = document.getElementById("edgeRule");
  const $city = document.getElementById("cityFilter");
  const $orgQ = document.getElementById("orgSearch");
  const $counts = document.getElementById("counts");
  const $reset = document.getElementById("reset");
  const $export = document.getElementById("export");

  // city options
  cities.sort().forEach(c => {
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = c; $city.appendChild(opt);
  });

  function rebuildEdges(kind) {
    graph.clearEdges();
    const ids = graph.nodes();

    if (kind === "random") {
      const m = Math.min(ids.length * 2, 600); // ~2x nodes
      let tries = 0;
      for (let i=0; i<m && tries < m*4; i++) {
        const s = ids[Math.floor(Math.random()*ids.length)];
        const t = ids[Math.floor(Math.random()*ids.length)];
        if (s !== t && !graph.hasEdge(s, t)) graph.addEdge(s, t, { kind, weight:1 });
        else tries++;
      }
      return;
    }

    // group by attribute
    const keyAttr = kind === "city" ? "city" : kind === "org" ? "org" : "event";
    const groups = {};
    graph.forEachNode((n, a) => {
      const key = a[keyAttr] || "(none)";
      (groups[key] ??= []).push(n);
    });

    // fully connect within group (small dataset; fine)
    Object.values(groups).forEach(list => {
      for (let i=0;i<list.length;i++) for (let j=i+1;j<list.length;j++) {
        graph.addEdge(list[i], list[j], { kind, weight: 1 });
      }
    });
  }

  // Reducers for filtering by city & org search
  function applyReducers() {
    const city = $city.value;
    const q = ($orgQ.value || "").toLowerCase();

    renderer.setSetting("nodeReducer", (n, a) => {
      const matchCity = !city || a.city === city;
      const matchOrg = !q || (a.org || "").toLowerCase().includes(q);
      const visible = matchCity && matchOrg;
      return visible ? a : { ...a, hidden: true };
    });

    renderer.setSetting("edgeReducer", (e, a) => {
      const [s, t] = graph.extremities(e);
      const sh = renderer.getNodeDisplayData(s)?.hidden;
      const th = renderer.getNodeDisplayData(t)?.hidden;
      return (sh || th) ? { ...a, hidden: true } : a;
    });

    renderer.refresh();
    updateCounts();
  }

  function updateCounts() {
    let visNodes = 0, visEdges = 0;
    graph.forEachNode(n => { if (!renderer.getNodeDisplayData(n)?.hidden) visNodes++; });
    graph.forEachEdge(e => { if (!renderer.getEdgeDisplayData(e)?.hidden) visEdges++; });
    $counts.textContent = `Nodes: ${visNodes}/${graph.order} • Edges: ${visEdges}/${graph.size} ` +
                          `• Rule: ${$edgeRule.value}` +
                          ( $city.value ? ` • City: ${$city.value}` : "" ) +
                          ( $orgQ.value ? ` • Org ~ "${$orgQ.value}"` : "" );
  }

  $edgeRule.onchange = () => { rebuildEdges($edgeRule.value); applyReducers(); };
  $city.onchange = applyReducers;
  $orgQ.oninput = applyReducers;
  $reset.onclick = () => { renderer.getCamera().animatedReset(); $city.value=""; $orgQ.value=""; applyReducers(); };
  $export.onclick = () => {
    const visible = new Set();
    const nodes = [], edges = [];
    graph.forEachNode(n => { if (!renderer.getNodeDisplayData(n)?.hidden) visible.add(n); });
    graph.forEachNode(n => { if (visible.has(n)) nodes.push({ id:n, ...graph.getNodeAttributes(n) }); });
    graph.forEachEdge(e => {
      const [s,t] = graph.extremities(e);
      if (visible.has(s) && visible.has(t)) edges.push({ id:e, source:s, target:t, ...graph.getEdgeAttributes(e) });
    });
    const blob = new Blob([JSON.stringify({nodes, edges}, null, 2)], {type:"application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "filtered-graph.json"; a.click();
  };

  // initial draw
  rebuildEdges($edgeRule.value);
  applyReducers();
</script>
</body>
</html>